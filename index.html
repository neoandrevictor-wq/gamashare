<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P RING MASTER | PROTOCOLO DISTRIBU√çDO</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #05070a; --panel: #0d1117; --text: #e6edf3;
            --accent: #2f81f7; --success: #238636; --danger: #da3633; --warn: #d29922;
            --log-bg: rgba(47, 129, 247, 0.05);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* MODAL TOS */
        #tos-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .tos-card { background: var(--panel); padding: 30px; border-radius: 12px; max-width: 500px; border: 1px solid var(--accent); max-height: 90vh; overflow-y: auto; }
        .tos-text { font-size: 13px; color: #8b949e; line-height: 1.6; text-align: justify; margin: 20px 0; }

        /* HEADER HUD */
        header { height: 60px; background: var(--panel); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; border-bottom: 1px solid #30363d; z-index: 100; }
        .hud-room { font-weight: bold; color: var(--accent); letter-spacing: 1px; font-size: 14px; text-transform: uppercase; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #21262d; }

        /* MAIN CONTENT */
        .main { display: flex; flex: 1; overflow: hidden; flex-direction: row; }
        @media (max-width: 768px) { .main { flex-direction: column; } }

        /* VIDEO AREA */
        .video-container { flex: 1.5; display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; overflow-y: auto; background: #000; align-content: flex-start; justify-content: center; }
        .v-cap { position: relative; width: 100%; max-width: 320px; aspect-ratio: 16/9; background: #161b22; border-radius: 8px; overflow: hidden; border: 1px solid #30363d; }
        .v-cap video { width: 100%; height: 100%; object-fit: cover; }
        .v-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 5px; font-size: 10px; display: flex; justify-content: space-between; }

        /* CHAT & LOGS AREA */
        .chat-panel { flex: 1; display: flex; flex-direction: column; background: var(--panel); border-left: 1px solid #30363d; min-width: 320px; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; font-size: 13px; }
        
        /* MSGS STYLES */
        .msg { padding: 8px 12px; border-radius: 8px; background: #161b22; border: 1px solid #30363d; max-width: 90%; word-break: break-word; }
        .msg.sys { background: var(--log-bg); border-color: rgba(47, 129, 247, 0.2); font-family: 'Courier New', monospace; font-size: 11px; color: #58a6ff; }
        .msg img { max-width: 100%; border-radius: 4px; margin-top: 8px; }
        .msg b { color: var(--accent); }

        /* INPUT AREA */
        .input-box { padding: 15px; background: #0d1117; border-top: 1px solid #30363d; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        input[type="text"] { flex: 1; background: #010409; border: 1px solid #30363d; color: white; padding: 10px; border-radius: 6px; outline: none; font-size: 14px; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; color: white; background: #238636; }
        .btn:hover { background: #2ea043; }
        .btn-util { background: #21262d; border: 1px solid #30363d; }

        /* SETUP OVERLAY */
        #setup-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid #30363d; width: 90%; max-width: 400px; text-align: center; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- MODAL TERMOS DE USO -->
    <div id="tos-modal">
        <div class="tos-card">
            <h2 style="color:var(--accent)">AVISO LEGAL E TERMOS</h2>
            <div class="tos-text">
                Este software √© um experimento cient√≠fico de redes P2P distribu√≠das. Ao utilizar, voc√™ concorda que:<br><br>
                1. <b>ISEN√á√ÉO DE RESPONSABILIDADE:</b> O desenvolvedor n√£o se responsabiliza por quaisquer dados transmitidos, danos de hardware, perda de dados ou uso indevido da ferramenta.<br><br>
                2. <b>USO L√çCITO:</b> √â terminantemente proibido o uso deste sistema para atividades il√≠citas, distribui√ß√£o de conte√∫do protegido ou ass√©dio. A rede √© ef√™mera e descentralizada.<br><br>
                3. <b>PRIVACIDADE:</b> N√£o h√° servidores centrais. A m√≠dia √© transmitida peer-to-peer. Sua conex√£o √© direta com outros participantes.<br><br>
                Ao clicar em aceitar, voc√™ assume total responsabilidade civil e criminal por seus atos dentro desta rede experimental.
            </div>
            <button class="btn" style="width:100%" onclick="acceptTos()">EU ACEITO E PROMETO USO √âTICO</button>
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setup-overlay" style="display:none">
        <div class="setup-card">
            <h2 style="margin-bottom:20px">CONFIGURAR N√ì</h2>
            <input type="text" id="nick-in" placeholder="Seu Apelido" value="User_" style="width:100%; margin-bottom:12px">
            <input type="text" id="room-in" placeholder="Nome da Sala" value="cluster-alpha" style="width:100%; margin-bottom:20px">
            <button class="btn" style="width:100%" onclick="initSystem()">ENTRAR NA REDE P2P</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <header>
        <div class="hud-room" id="hud-room">...</div>
        <div style="display:flex; gap:8px">
            <span id="ring-tag" class="tag" style="color:var(--danger)">ANEL ABERTO</span>
            <span id="id-tag" class="tag">ID: --</span>
        </div>
    </header>

    <div class="main">
        <div class="video-container" id="video-grid"></div>
        
        <aside class="chat-panel">
            <div id="chat-msgs"></div>
            
            <div class="input-box">
                <div class="input-row">
                    <button class="btn btn-util" onclick="toggleMute('audio')">üéôÔ∏è</button>
                    <button class="btn btn-util" onclick="toggleMute('video')">üì∑</button>
                    <button class="btn btn-util" onclick="shareScreen()">üì∫</button>
                </div>
                <div class="input-row" style="margin-top:10px">
                    <input type="text" id="msg-input" placeholder="Mensagem / Cole Imagens..." onkeypress="if(event.key==='Enter') sendChat()">
                    <input type="file" id="file-in" style="display:none" onchange="sendFile(this)">
                    <button class="btn btn-util" onclick="document.getElementById('file-in').click()">üìÅ</button>
                    <button class="btn" onclick="sendChat()">ENVIAR</button>
                </div>
            </div>
        </aside>
    </div>

<script>
/**
 * üõ† ARQUITETURA P2P RING MASTER | V. FINAL CI√äNTIFICA
 */

const STATE = {
    id: 'n' + Math.random().toString(36).substr(2, 4),
    name: '', room: '',
    ring: [], 
    peers: {}, channels: {},
    seen: new Set(),
    mqtt: null,
    currentNext: null,
    localStream: null
};

const RTC_CONF = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

// --- GEST√ÉO DE ACESSO ---
function acceptTos() {
    localStorage.setItem('p2p_tos_v1', 'accepted');
    document.getElementById('tos-modal').style.display = 'none';
    document.getElementById('setup-overlay').style.display = 'flex';
}

window.onload = () => {
    if(localStorage.getItem('p2p_tos_v1')) {
        document.getElementById('tos-modal').style.display = 'none';
        document.getElementById('setup-overlay').style.display = 'flex';
    }
};

async function initSystem() {
    STATE.name = document.getElementById('nick-in').value || 'Anon';
    STATE.room = document.getElementById('room-in').value || 'default';
    STATE.ring = [STATE.id];

    document.getElementById('setup-overlay').style.display = 'none';
    document.getElementById('hud-room').innerText = STATE.room;
    document.getElementById('id-tag').innerText = `ID: ${STATE.id}`;

    try {
        STATE.localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        addVideo(STATE.id, `${STATE.name} (Voc√™)`, STATE.localStream);
    } catch(e) { trace("Aviso: Sem hardware de m√≠dia."); }

    initMqtt();
    // Preven√ß√£o de travamento: Aceitar novos peers periodicamente
    setInterval(checkRingHealth, 10000);
}

// --- LOGS INTEGRADOS ---
function trace(msg, isSys = true) {
    const area = document.getElementById('chat-msgs');
    const div = document.createElement('div');
    div.className = isSys ? 'msg sys' : 'msg';
    div.innerHTML = isSys ? `[SYSTEM] ${msg}` : msg;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

// --- SINALIZA√á√ÉO MQTT ---
function initMqtt() {
    STATE.mqtt = mqtt.connect('wss://test.mosquitto.org:8081');
    const base = `p2p_science_vfinal_${STATE.room}`;

    STATE.mqtt.on('connect', () => {
        trace("Conectado √† infraestrutura de sinaliza√ß√£o.");
        STATE.mqtt.subscribe(`${base}/announce`);
        STATE.mqtt.subscribe(`${base}/direct/${STATE.id}`);
        STATE.mqtt.publish(`${base}/announce`, JSON.stringify({type: 'JOIN', id: STATE.id}));
    });

    STATE.mqtt.on('message', (topic, payload) => {
        const data = JSON.parse(payload.toString());
        if (topic.endsWith('/announce') && data.id !== STATE.id) {
            handleJoin(data.id, base);
        } else {
            handleDirect(data);
        }
    });
}

function handleJoin(peerId, base) {
    // Super Peer (menor ID coordena a entrada de novos membros)
    const all = [...new Set([...STATE.ring, STATE.id, peerId])].sort();
    STATE.ring = all;
    
    if (STATE.id === all[0]) {
        trace(`Coordenando entrada de novo Peer: ${peerId}`);
        STATE.ring.forEach(pid => {
            STATE.mqtt.publish(`${base}/direct/${pid}`, JSON.stringify({type: 'MAP', ring: STATE.ring}));
        });
    }
    recalculateRing();
}

async function handleDirect(data) {
    if (data.type === 'MAP') {
        STATE.ring = data.ring;
        recalculateRing();
    } else if (data.type === 'OFFER') {
        await handleOffer(data);
    } else if (data.type === 'ANSWER') {
        if (STATE.peers[data.from]) await STATE.peers[data.from].setRemoteDescription(new RTCSessionDescription(data.sdp));
    } else if (data.type === 'ICE') {
        if (STATE.peers[data.from]) await STATE.peers[data.from].addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e=>{});
    }
}

// --- DIN√ÇMICA DO ANEL ---
function recalculateRing() {
    const idx = STATE.ring.indexOf(STATE.id);
    if (idx === -1 || STATE.ring.length < 2) return;

    const nextId = STATE.ring[(idx + 1) % STATE.ring.length];
    
    if (STATE.currentNext !== nextId) {
        trace(`Atualizando vizinho no anel para: ${nextId}`);
        STATE.currentNext = nextId;
        // O ID Maior inicia para evitar colis√£o (Polite Strategy)
        if (STATE.id > nextId) initWebRTC(nextId);
    }
}

async function initWebRTC(targetId) {
    const pc = createPC(targetId);
    const dc = pc.createDataChannel("ring-data");
    setupDC(dc, targetId);

    if (STATE.localStream) STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendSignal(targetId, {type: 'OFFER', sdp: offer});
}

async function handleOffer(data) {
    const pc = createPC(data.from);
    if (STATE.localStream) STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendSignal(data.from, {type: 'ANSWER', sdp: answer});
}

function createPC(peerId) {
    if (STATE.peers[peerId]) STATE.peers[peerId].close();
    const pc = new RTCPeerConnection(RTC_CONF);
    STATE.peers[peerId] = pc;

    pc.onicecandidate = e => { if (e.candidate) sendSignal(peerId, {type: 'ICE', candidate: e.candidate}); };
    pc.ondatachannel = e => setupDC(e.channel, peerId);
    
    pc.ontrack = e => {
        addVideo(peerId, `Peer: ${peerId}`, e.streams[0]);
        // RELAY DE M√çDIA
        if (STATE.currentNext && STATE.currentNext !== peerId) {
            const nextPC = STATE.peers[STATE.currentNext];
            if (nextPC && nextPC.signalingState === 'stable') {
                try { nextPC.addTrack(e.track, e.streams[0]); applyQuality(nextPC); } catch(err) {}
            }
        }
    };

    pc.onconnectionstatechange = () => {
        const tag = document.getElementById('ring-tag');
        if (pc.connectionState === 'connected') {
            tag.innerText = "ANEL CONECTADO"; tag.style.color = "var(--success)";
        } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
            tag.innerText = "ANEL ABERTO"; tag.style.color = "var(--danger)";
            healRing(peerId);
        }
    };
    return pc;
}

// --- MULTIM√çDIA E RELAY ---
function setupDC(dc, peerId) {
    STATE.channels[peerId] = dc;
    dc.onmessage = e => {
        const data = JSON.parse(e.data);
        if (STATE.seen.has(data.uid)) return;
        STATE.seen.add(data.uid);
        renderMsg(data);
        relayData(data);
    };
}

function relayData(data) {
    if (STATE.currentNext) {
        const dc = STATE.channels[STATE.currentNext];
        if (dc && dc.readyState === 'open') dc.send(JSON.stringify(data));
    }
}

function broadcast(type, payload) {
    const data = { uid: Math.random().toString(36).substr(2, 9), origin: STATE.id, sender: STATE.name, type: type, ...payload };
    STATE.seen.add(data.uid);
    renderMsg(data);
    relayData(data);
}

// --- UI HANDLERS ---
function sendChat() {
    const el = document.getElementById('msg-input');
    if (!el.value) return;
    broadcast('chat', {text: el.value});
    el.value = '';
}

document.getElementById('msg-input').onpaste = (e) => {
    const items = e.clipboardData.items;
    for (let item of items) {
        if (item.type.indexOf("image") !== -1) {
            const reader = new FileReader();
            reader.onload = (evt) => broadcast('img', {data: evt.target.result});
            reader.readAsDataURL(item.getAsFile());
        }
    }
};

function sendFile(input) {
    const file = input.files[0];
    if (file.size > 2 * 1024 * 1024) return alert("Limite 2MB");
    const reader = new FileReader();
    reader.onload = (e) => broadcast('file', {data: e.target.result, name: file.name});
    reader.readAsDataURL(file);
}

function renderMsg(msg) {
    const area = document.getElementById('chat-msgs');
    const div = document.createElement('div');
    div.className = 'msg';
    let html = `<b>${msg.sender}:</b> `;
    if (msg.type === 'chat') html += `<span>${msg.text}</span>`;
    if (msg.type === 'img') html += `<img src="${msg.data}">`;
    if (msg.type === 'file') html += `<br><a href="${msg.data}" download="${msg.name}" style="color:var(--success)">üìÅ Baixar ${msg.name}</a>`;
    div.innerHTML = html;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
}

function addVideo(id, label, stream) {
    if (document.getElementById(`v-${id}`)) return;
    const grid = document.getElementById('video-grid');
    const div = document.createElement('div');
    div.id = `v-${id}`; div.className = 'v-cap';
    div.innerHTML = `<video autoplay playsinline></video><div class="v-label">${label}</div>`;
    grid.appendChild(div);
    div.querySelector('video').srcObject = stream;
}

function applyQuality(pc) {
    const hops = STATE.ring.length;
    let fps = hops > 4 ? 5 : 15;
    pc.getSenders().forEach(s => {
        if(s.track && s.track.kind === 'video') {
            const p = s.getParameters();
            if(!p.encodings) p.encodings = [{}];
            p.encodings[0].maxFramerate = fps;
            s.setParameters(p);
        }
    });
}

function healRing(failedId) {
    STATE.ring = STATE.ring.filter(id => id !== failedId);
    const v = document.getElementById(`v-${failedId}`);
    if(v) v.remove();
    recalculateRing();
}

function checkRingHealth() {
    if(STATE.mqtt) STATE.mqtt.publish(`p2p_science_vfinal_${STATE.room}/announce`, JSON.stringify({type: 'JOIN', id: STATE.id}));
}

function sendSignal(to, payload) {
    payload.from = STATE.id;
    STATE.mqtt.publish(`p2p_science_vfinal_${STATE.room}/direct/${to}`, JSON.stringify(payload));
}

function toggleMute(type) {
    if(!STATE.localStream) return;
    const t = type === 'audio' ? STATE.localStream.getAudioTracks()[0] : STATE.localStream.getVideoTracks()[0];
    if(t) t.enabled = !t.enabled;
}

async function shareScreen() {
    try {
        const s = await navigator.mediaDevices.getDisplayMedia({video:true});
        const t = s.getVideoTracks()[0];
        Object.values(STATE.peers).forEach(pc => {
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if(sender) sender.replaceTrack(t);
        });
    } catch(e) {}
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P RING MASTER | PROJETO EXPERIMENTAL</title>
    <!-- Bibliotecas externas via CDN -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --success: #238636;
            --danger: #f85149;
            --warn: #d29922;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            font-family: -apple-system, system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* LEGAL MODAL (TOS) */
        #tos-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tos-card {
            background: var(--panel);
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            border: 1px solid var(--accent);
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
        }

        .tos-text {
            font-size: 13px;
            color: #8b949e;
            line-height: 1.6;
            text-align: justify;
            margin: 20px 0;
            border-top: 1px solid #30363d;
            padding-top: 15px;
        }

        /* SETUP SCREEN */
        #setup-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            background: var(--panel);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #30363d;
            width: 95%;
            max-width: 400px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #010409;
            border: 1px solid #30363d;
            color: white;
            border-radius: 6px;
            outline: none;
        }

        /* HUD / HEADER */
        header {
            height: 60px;
            background: var(--panel);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 100;
        }

        .room-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
        }

        .hud-tags {
            display: flex;
            gap: 5px;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            background: #21262d;
        }

        /* LAYOUT PRINCIPAL */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        @media (max-width: 850px) {
            .app-container {
                flex-direction: column;
            }
        }

        /* GRID DE V√çDEOS */
        .video-grid {
            flex: 1.5;
            background: #000;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            padding: 10px;
            align-content: flex-start;
        }

        @media (max-width: 600px) {
            .video-grid {
                flex: 1;
                grid-template-columns: 1fr;
            }
        }

        .v-item {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #161b22;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #30363d;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .v-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .v-label {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* CHAT E LOGS (INTEGRADOS) */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border-left: 1px solid #30363d;
            min-width: 350px;
        }

        @media (max-width: 850px) {
            .chat-section {
                flex: 1.5;
                border-left: none;
                border-top: 1px solid #30363d;
            }
        }

        #chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .m-item {
            font-size: 13px;
            padding: 10px;
            border-radius: 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            max-width: 95%;
            word-break: break-word;
        }

        .m-item.sys {
            background: rgba(88, 166, 255, 0.05);
            color: #58a6ff;
            font-family: var(--font-mono);
            font-size: 11px;
            border-color: rgba(88, 166, 255, 0.2);
            align-self: stretch;
            max-width: 100%;
        }

        .m-item b {
            color: var(--accent);
        }

        .m-item img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 5px;
            display: block;
        }

        /* √ÅREA DE ENTRADA (MOBILE RESPONSIVE + 30PX LIFT) */
        .input-controls {
            padding: 15px 15px 45px 15px;
            background: var(--panel);
            border-top: 1px solid #30363d;
        }

        .btn-row {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .text-row {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            background: #21262d;
            border: 1px solid #30363d;
            white-space: nowrap;
        }

        .btn-send {
            background: var(--success);
            border: none;
            padding: 0 20px;
        }

        .btn:active {
            transform: scale(0.96);
        }

        /* CR√âDITOS */
        .credits {
            font-size: 10px;
            color: #484f58;
            margin-top: 10px;
            text-decoration: none;
            display: block;
        }

        .credits:hover {
            color: var(--accent);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <!-- MODAL DE TERMOS (PROTE√á√ÉO LEGAL) -->
    <div id="tos-modal">
        <div class="tos-card">
            <h2>AVISO DE RESPONSABILIDADE</h2>
            <div class="tos-text">
                Este sistema √© uma ferramenta de comunica√ß√£o P2P (Peer-to-Peer) descentralizada experimental.
                Ao prosseguir, voc√™ reconhece que: <br><br>
                1. <b>Sem Servidores:</b> N√£o h√° armazenamento central. Toda m√≠dia (√°udio, v√≠deo, arquivos) √©
                transmitida diretamente entre usu√°rios.<br>
                2. <b>Uso √âtico:</b> Voc√™ se compromete a n√£o utilizar esta rede para fins il√≠citos, criminosos ou
                ass√©dio.<br>
                3. <b>Isen√ß√£o:</b> O desenvolvedor n√£o possui meios de monitorar ou filtrar o tr√°fego e n√£o se
                responsabiliza por condutas de terceiros.<br>
                4. <b>Conectividade:</b> Sua conex√£o P2P exp√µe seu IP aos participantes diretos do anel para viabilizar
                o tr√°fego.
            </div>
            <button class="btn" style="background:var(--success); width:100%; padding:15px; border:none;"
                onclick="acceptTos()">ACEITO OS TERMOS E CONDI√á√ïES</button>
            <a href="https://gamanext-ia.vercel.app" target="_blank" class="credits">Powered by
                gamanext-ia.vercel.app</a>
        </div>
    </div>

    <!-- SETUP -->
    <div id="setup-overlay" style="display:none">
        <div class="setup-card">
            <h2 style="color:var(--accent); margin-bottom:10px">CONFIGURAR N√ì</h2>
            <input type="text" id="nick" placeholder="Seu Nickname" value="Peer_">
            <input type="text" id="room" placeholder="ID da Sala (Ex: lab-01)" value="p2p-ring-room">
            <button class="btn" style="background:var(--accent); width:100%; padding:15px; border:none;"
                onclick="startProtocol()">INICIAR PROTOCOLO</button>
        </div>
    </div>

    <!-- HUD -->
    <header>
        <div class="room-title" id="hud-room">...</div>
        <div class="hud-tags">
            <span id="ring-status" class="tag" style="color:var(--danger)">RING: OPEN</span>
            <span id="my-id" class="tag">ID: --</span>
        </div>
    </header>

    <!-- MAIN -->
    <div class="app-container">
        <div class="video-grid" id="video-grid"></div>

        <section class="chat-section">
            <div id="chat-list">
                <div class="m-item sys">[INFO] Sistema inicializado. Aguardando aceite dos termos.</div>
            </div>

            <div class="input-controls">
                <div class="btn-row">
                    <button class="btn" onclick="toggleMute('audio')">MIC</button>
                    <button class="btn" onclick="toggleMute('video')">CAM</button>
                    <button class="btn" onclick="shareScreen()">TELA</button>
                    <button class="btn" onclick="document.getElementById('file-in').click()">ARQUIVO</button>
                    <input type="file" id="file-in" style="display:none" onchange="sendFile(this)">
                </div>
                <div class="text-row">
                    <input type="text" id="msg-input" placeholder="Mensagem ou Cole Imagem..."
                        onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn btn-send" onclick="sendChat()">ENVIAR</button>
                </div>
                <a href="https://gamanext-ia.vercel.app" target="_blank" class="credits"
                    style="text-align:center">gamanext-ia.vercel.app</a>
            </div>
        </section>
    </div>

    <script>
        /**
         * ‚öõÔ∏è ARQUITETURA P2P RING MASTER | V. FINAL SEM OMISS√ïES
         */

        const STATE = {
            id: 'n' + Math.random().toString(36).substr(2, 4),
            name: '', room: '',
            ring: [], // IDs ordenados
            peers: {}, channels: {},
            seen: new Set(),
            mqtt: null,
            currentNext: null,
            localStream: null,
            isSuper: false
        };

        const RTC_CONF = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        // --- GEST√ÉO DE ACESSO ---
        function acceptTos() {
            localStorage.setItem('p2p_science_tos', 'true');
            document.getElementById('tos-modal').style.display = 'none';
            document.getElementById('setup-overlay').style.display = 'flex';
        }

        window.onload = () => {
            if (localStorage.getItem('p2p_science_tos')) {
                document.getElementById('tos-modal').style.display = 'none';
                document.getElementById('setup-overlay').style.display = 'flex';
            }
        };

        async function startProtocol() {
            STATE.name = document.getElementById('nick').value || 'Anon';
            STATE.room = document.getElementById('room').value || 'default';
            STATE.ring = [STATE.id];

            document.getElementById('setup-overlay').style.display = 'none';
            document.getElementById('hud-room').innerText = `ROOM: ${STATE.room}`;
            document.getElementById('my-id').innerText = `ID: ${STATE.id}`;

            try {
                STATE.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideo(STATE.id, `${STATE.name} (Voc√™)`, STATE.localStream);
            } catch (e) { logSys("Hardware de m√≠dia n√£o encontrado. Modo espectador."); }

            initSignaling(); // Corrigido: Chamada correta da fun√ß√£o
            setInterval(heartbeat, 10000); // Heartbeat peri√≥dico para manter anel vivo
        }

        // --- TELEMETRIA NO CHAT ---
        function logSys(msg) {
            const chat = document.getElementById('chat-list');
            const div = document.createElement('div');
            div.className = 'm-item sys';
            div.innerHTML = `[P2P-LOG] ${msg}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // --- SINALIZA√á√ÉO MQTT ---
        function initSignaling() {
            STATE.mqtt = mqtt.connect('wss://test.mosquitto.org:8081');
            const base = `p2p_v_final_full_${STATE.room}`;

            STATE.mqtt.on('connect', () => {
                logSys("Conectado √† infraestrutura global de sinaliza√ß√£o.");
                STATE.mqtt.subscribe(`${base}/announce`);
                STATE.mqtt.subscribe(`${base}/direct/${STATE.id}`);
                STATE.mqtt.publish(`${base}/announce`, JSON.stringify({ type: 'JOIN', id: STATE.id }));
            });

            STATE.mqtt.on('message', (topic, payload) => {
                const data = JSON.parse(payload.toString());
                if (topic.endsWith('/announce') && data.id !== STATE.id) {
                    handleDiscovery(data.id, base);
                } else {
                    handleDirect(data);
                }
            });
        }

        function handleDiscovery(peerId, base) {
            const all = [...new Set([...STATE.ring, STATE.id, peerId])].sort();
            STATE.ring = all;

            // Elei√ß√£o de Super Peer (Menor ID alfab√©tico)
            if (STATE.id === all[0]) {
                STATE.isSuper = true;
                logSys("Assumindo papel de Coordenador (Super Peer).");
                STATE.ring.forEach(pid => {
                    STATE.mqtt.publish(`${base}/direct/${pid}`, JSON.stringify({ type: 'MAP', ring: STATE.ring }));
                });
            }
            recalculateNeighbors();
        }

        async function handleDirect(data) {
            if (data.type === 'MAP') {
                STATE.ring = data.ring;
                recalculateNeighbors();
            } else if (data.type === 'OFFER') {
                logSys(`Handshake: Recebida oferta de ${data.from}`);
                await handleOffer(data);
            } else if (data.type === 'ANSWER') {
                const pc = STATE.peers[data.from];
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            } else if (data.type === 'ICE') {
                const pc = STATE.peers[data.from];
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(() => { });
            }
        }

        // --- TOPOLOGIA EM ANEL COM POLITE PEER E BYPASS ---
        function recalculateNeighbors() {
            const idx = STATE.ring.indexOf(STATE.id);
            if (idx === -1 || STATE.ring.length < 2) return;

            const nextId = STATE.ring[(idx + 1) % STATE.ring.length];

            if (STATE.currentNext !== nextId) {
                logSys(`Anel: Novo vizinho detectado -> ${nextId}`);
                STATE.currentNext = nextId;
                // Polite Peer: O ID maior inicia o handshake para evitar colis√£o de SDP
                if (STATE.id > nextId) initWebRTC(nextId);
            }
        }

        async function initWebRTC(targetId) {
            const pc = createPC(targetId);
            const dc = pc.createDataChannel("ring-data");
            setupDC(dc, targetId);

            if (STATE.localStream) {
                STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));
            }

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal(targetId, { type: 'OFFER', sdp: offer });
        }

        async function handleOffer(data) {
            const pc = createPC(data.from);
            if (STATE.localStream) {
                STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));
            }
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendSignal(data.from, { type: 'ANSWER', sdp: answer });
        }

        function createPC(peerId) {
            if (STATE.peers[peerId]) STATE.peers[peerId].close();
            const pc = new RTCPeerConnection(RTC_CONF);
            STATE.peers[peerId] = pc;

            pc.onicecandidate = e => { if (e.candidate) sendSignal(peerId, { type: 'ICE', candidate: e.candidate }); };
            pc.ondatachannel = e => setupDC(e.channel, peerId);

            pc.ontrack = e => {
                addVideo(peerId, `Peer: ${peerId}`, e.streams[0]);
                // RELAY DE M√çDIA PEER-TO-PEER (O anel repassa a m√≠dia)
                if (STATE.currentNext && STATE.currentNext !== peerId) {
                    const nextPC = STATE.peers[STATE.currentNext];
                    if (nextPC && nextPC.signalingState === 'stable') {
                        try {
                            nextPC.addTrack(e.track, e.streams[0]);
                            applyAdaptiveQuality(nextPC);
                        } catch (err) { }
                    }
                }
            };

            pc.onconnectionstatechange = () => {
                const tag = document.getElementById('ring-status');
                if (pc.connectionState === 'connected') {
                    tag.innerText = "RING: CLOSED"; tag.style.color = "var(--success)";
                } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    tag.innerText = "RING: OPEN"; tag.style.color = "var(--danger)";
                    healRing(peerId);
                }
            };
            return pc;
        }

        // --- DATA CHANNEL / RELAY DE DADOS ---
        function setupDC(dc, peerId) {
            STATE.channels[peerId] = dc;
            dc.onmessage = e => {
                const data = JSON.parse(e.data);
                if (STATE.seen.has(data.uid)) return;
                STATE.seen.add(data.uid);
                appendMsg(data);
                relayData(data); // Relay P2P de dados
            };
        }

        function relayData(data) {
            if (STATE.currentNext) {
                const dc = STATE.channels[STATE.currentNext];
                if (dc && dc.readyState === 'open') dc.send(JSON.stringify(data));
            }
        }

        function broadcast(type, payload) {
            const data = { uid: Math.random().toString(36).substr(2, 9), origin: STATE.id, sender: STATE.name, type: type, ...payload };
            STATE.seen.add(data.uid);
            appendMsg(data);
            relayData(data);
        }

        // --- MULTIM√çDIA E UI ---
        function sendChat() {
            const el = document.getElementById('msg-input');
            if (!el.value) return;
            broadcast('chat', { text: el.value });
            el.value = '';
        }

        document.getElementById('msg-input').onpaste = (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf("image") !== -1) {
                    const reader = new FileReader();
                    reader.onload = (evt) => broadcast('img', { data: evt.target.result });
                    reader.readAsDataURL(item.getAsFile());
                }
            }
        };

        function sendFile(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 3 * 1024 * 1024) return alert("Limite de 3MB para prot√≥tipo P2P.");
            const reader = new FileReader();
            reader.onload = (e) => broadcast('file', { data: e.target.result, name: file.name });
            reader.readAsDataURL(file);
        }

        function appendMsg(msg) {
            const area = document.getElementById('chat-list');
            const div = document.createElement('div');
            div.className = 'm-item';
            let content = `<b>${msg.sender}:</b> `;
            if (msg.type === 'chat') content += `<span>${msg.text}</span>`;
            if (msg.type === 'img') content += `<img src="${msg.data}">`;
            if (msg.type === 'file') content += `<br><a href="${msg.data}" download="${msg.name}" style="color:var(--success); font-weight:bold;">üìÅ Baixar: ${msg.name}</a>`;
            area.appendChild(div);
            div.innerHTML = content;
            area.scrollTop = area.scrollHeight;
        }

        function addVideo(id, label, stream) {
            if (document.getElementById(`v-${id}`)) return;
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.id = `v-${id}`; div.className = 'v-item';
            div.innerHTML = `<video autoplay playsinline></video><div class="v-label">${label}</div>`;
            grid.appendChild(div);
            div.querySelector('video').srcObject = stream;
        }

        // --- QUALIDADE ADAPTATIVA (PROGRESSIVA) ---
        function applyAdaptiveQuality(pc) {
            const members = STATE.ring.length;
            let targetFPS = 30;
            let scale = 1;

            if (members > 3) { targetFPS = 15; scale = 2; }
            if (members > 6) { targetFPS = 5; scale = 4; }

            pc.getSenders().forEach(s => {
                if (s.track && s.track.kind === 'video') {
                    const p = s.getParameters();
                    if (!p.encodings) p.encodings = [{}];
                    p.encodings[0].maxFramerate = targetFPS;
                    p.encodings[0].scaleResolutionDownBy = scale;
                    s.setParameters(p).catch(() => { });
                }
            });
        }

        function healRing(failedId) {
            STATE.ring = STATE.ring.filter(id => id !== failedId);
            const v = document.getElementById(`v-${failedId}`);
            if (v) v.remove();
            recalculateNeighbors();
            logSys(`Self-Healing: N√≥ ${failedId} removido. Reconfigurando anel...`);
        }

        function heartbeat() {
            if (STATE.mqtt) STATE.mqtt.publish(`p2p_v_final_full_${STATE.room}/announce`, JSON.stringify({ type: 'JOIN', id: STATE.id }));
        }

        function sendSignal(to, payload) {
            payload.from = STATE.id;
            STATE.mqtt.publish(`p2p_v_final_full_${STATE.room}/direct/${to}`, JSON.stringify(payload));
        }

        function toggleMute(type) {
            if (!STATE.localStream) return;
            const t = type === 'audio' ? STATE.localStream.getAudioTracks()[0] : STATE.localStream.getVideoTracks()[0];
            if (t) t.enabled = !t.enabled;
        }

        async function shareScreen() {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const t = s.getVideoTracks()[0];
                Object.values(STATE.peers).forEach(pc => {
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(t);
                });
                t.onended = () => {
                    const cam = STATE.localStream.getVideoTracks()[0];
                    Object.values(STATE.peers).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(cam);
                    });
                };
            } catch (e) { logSys("Erro ao capturar tela."); }
        }
    </script>
</body>

</html>
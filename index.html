<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P RING MASTER | V. FINAL</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --success: #238636;
            --danger: #f85149;
            --warn: #d29922;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            font-family: -apple-system, system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* LEGAL MODAL */
        #tos-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tos-card {
            background: var(--panel);
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            border: 1px solid var(--accent);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .tos-card h2 {
            color: var(--accent);
            margin-bottom: 15px;
        }

        .tos-text {
            font-size: 13px;
            color: #8b949e;
            line-height: 1.6;
            text-align: left;
            margin-bottom: 20px;
        }

        /* SETUP SCREEN */
        #setup-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            background: var(--panel);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #30363d;
            width: 90%;
            max-width: 380px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #010409;
            border: 1px solid #30363d;
            color: white;
            border-radius: 6px;
            outline: none;
        }

        /* HUD AREA */
        header {
            height: 60px;
            background: var(--panel);
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .room-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .hud-tags {
            display: flex;
            gap: 5px;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            background: #21262d;
            white-space: nowrap;
        }

        /* MAIN RESPONSIVE LAYOUT */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        @media (max-width: 800px) {
            .app-container {
                flex-direction: column;
            }
        }

        /* VIDEO AREA */
        .video-grid {
            flex: 1.2;
            background: #000;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 8px;
            padding: 8px;
            align-content: flex-start;
        }

        @media (max-width: 800px) {
            .video-grid {
                flex: 0.8;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }

        .v-item {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #161b22;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #30363d;
        }

        .v-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .v-label {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* CHAT AREA */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border-left: 1px solid #30363d;
            min-width: 320px;
            position: relative;
        }

        @media (max-width: 800px) {
            .chat-section {
                flex: 1.2;
                border-left: none;
                border-top: 1px solid #30363d;
            }
        }

        #chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .m-item {
            font-size: 13px;
            line-height: 1.5;
            padding: 8px 12px;
            border-radius: 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            align-self: flex-start;
            max-width: 90%;
            word-break: break-word;
        }

        .m-item.sys {
            background: rgba(88, 166, 255, 0.05);
            color: #58a6ff;
            font-family: var(--font-mono);
            font-size: 11px;
            border-color: rgba(88, 166, 255, 0.2);
            max-width: 100%;
            align-self: stretch;
        }

        .m-item b {
            color: var(--accent);
        }

        .m-item img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 5px;
            border: 1px solid #30363d;
        }

        /* INPUT AREA */
        .input-controls {
            padding: 12px;
            background: var(--panel);
            border-top: 1px solid #30363d;
        }

        .btn-row {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .text-row {
            display: flex;
            gap: 6px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            background: #21262d;
            border: 1px solid #30363d;
            transition: 0.2s;
        }

        .btn-send {
            flex: none;
            width: 80px;
            background: var(--success);
            border: none;
        }

        .btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <!-- MODAL DE TERMOS -->
    <div id="tos-modal">
        <div class="tos-card">
            <h2>CI√äNCIA P2P: TERMOS DE USO</h2>
            <div class="tos-text">
                <b>1. PROP√ìSITO:</b> Este √© um artefato t√©cnico-cient√≠fico para estudo de redes descentralizadas. O
                sistema opera sem servidores centrais de m√≠dia.<br><br>
                <b>2. RESPONSABILIDADE:</b> O desenvolvedor N√ÉO possui controle sobre os dados trafegados. Voc√™ √© o
                √∫nico respons√°vel legal por qualquer conte√∫do transmitido (voz, v√≠deo, arquivos ou texto).<br><br>
                <b>3. PRIVACIDADE:</b> Sua conex√£o √© direta (P2P) com outros usu√°rios. Seu endere√ßo IP pode ser vis√≠vel
                aos peers conectados para viabilizar o transporte de dados.<br><br>
                <b>4. USO PROIBIDO:</b> √â proibido o uso para fins il√≠citos, criminosos ou distribui√ß√£o de material sem
                autoriza√ß√£o legal.
            </div>
            <button class="btn" style="background:var(--success); border:none; padding:15px;" onclick="acceptTos()">LI E
                ACEITO OS TERMOS</button>
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setup-overlay" style="display:none">
        <div class="setup-card">
            <h2 style="margin-bottom:15px; color:var(--accent)">PROTOCOL SETUP</h2>
            <input type="text" id="nick" placeholder="Seu Nickname" value="User_">
            <input type="text" id="room" placeholder="Identificador da Sala" value="science-lab">
            <button class="btn" style="background:var(--accent); border:none; padding:15px;"
                onclick="startProtocol()">INICIALIZAR PROTOCOLO</button>
        </div>
    </div>

    <!-- HEADER HUD -->
    <header>
        <div class="room-title" id="hud-room">...</div>
        <div class="hud-tags">
            <span id="ring-status" class="tag" style="color:var(--danger)">OFFLINE</span>
            <span id="my-id" class="tag">ID: --</span>
        </div>
    </header>

    <!-- MAIN INTERFACE -->
    <div class="app-container">
        <div class="video-grid" id="video-grid"></div>

        <section class="chat-section">
            <div id="chat-list"></div>

            <div class="input-controls">
                <div class="btn-row">
                    <button class="btn" onclick="toggleMute('audio')">MIC</button>
                    <button class="btn" onclick="toggleMute('video')">CAM</button>
                    <button class="btn" onclick="shareScreen()">TELA</button>
                    <button class="btn" onclick="document.getElementById('file-in').click()">ARQ</button>
                    <input type="file" id="file-in" style="display:none" onchange="sendFile(this)">
                </div>
                <div class="text-row">
                    <input type="text" id="msg-input" placeholder="Mensagem ou Cole Imagem..."
                        onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn btn-send" onclick="sendChat()">ENVIAR</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        /**
         * ‚öõÔ∏è P2P RING MASTER ARCHITECTURE - REVIS√ÉO FINAL
         */

        const STATE = {
            id: 'n' + Math.random().toString(36).substr(2, 4),
            name: '', room: '',
            ring: [], peers: {}, channels: {},
            seen: new Set(),
            mqtt: null,
            currentNext: null,
            localStream: null
        };

        const RTC_CONF = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        // --- GEST√ÉO DE ACESSO ---
        function acceptTos() {
            localStorage.setItem('p2p_accepted_tos', 'true');
            document.getElementById('tos-modal').style.display = 'none';
            document.getElementById('setup-overlay').style.display = 'flex';
        }

        window.onload = () => {
            if (localStorage.getItem('p2p_accepted_tos')) {
                document.getElementById('tos-modal').style.display = 'none';
                document.getElementById('setup-overlay').style.display = 'flex';
            }
        };

        async function startProtocol() {
            STATE.name = document.getElementById('nick').value || 'Anon';
            STATE.room = document.getElementById('room').value || 'default';
            STATE.ring = [STATE.id];

            document.getElementById('setup-overlay').style.display = 'none';
            document.getElementById('hud-room').innerText = `SALA: ${STATE.room}`;
            document.getElementById('my-id').innerText = `ID: ${STATE.id}`;

            try {
                STATE.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideo(STATE.id, `${STATE.name} (Voc√™)`, STATE.localStream);
            } catch (e) { logSys("M√≠dia local inacess√≠vel."); }

            initSignaling();
            setInterval(refreshRing, 10000); // Tenta reintegrar ou achar novos peers
        }

        // --- LOGS INTEGRADOS NO CHAT ---
        function logSys(msg) {
            const chat = document.getElementById('chat-list');
            const div = document.createElement('div');
            div.className = 'm-item sys';
            div.innerHTML = `[ST-LOG] ${msg}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // --- SINALIZA√á√ÉO MQTT ---
        function initMqtt() {
            STATE.mqtt = mqtt.connect('wss://test.mosquitto.org:8081');
            const base = `p2p_science_vfinal_fix_${STATE.room}`;

            STATE.mqtt.on('connect', () => {
                logSys("Conectado ao Broker de Sinaliza√ß√£o.");
                STATE.mqtt.subscribe(`${base}/announce`);
                STATE.mqtt.subscribe(`${base}/direct/${STATE.id}`);
                STATE.mqtt.publish(`${base}/announce`, JSON.stringify({ type: 'JOIN', id: STATE.id }));
            });

            STATE.mqtt.on('message', (topic, payload) => {
                const data = JSON.parse(payload.toString());
                if (topic.endsWith('/announce') && data.id !== STATE.id) {
                    handleJoin(data.id, base);
                } else {
                    handleDirect(data);
                }
            });
        }

        function handleJoin(peerId, base) {
            const all = [...new Set([...STATE.ring, STATE.id, peerId])].sort();
            STATE.ring = all;

            if (STATE.id === all[0]) {
                logSys(`Super Peer: Distribuindo Mapa de Anel: ${all.length} membros.`);
                STATE.ring.forEach(pid => {
                    STATE.mqtt.publish(`${base}/direct/${pid}`, JSON.stringify({ type: 'MAP', ring: STATE.ring }));
                });
            }
            recalculateRing();
        }

        async function handleDirect(data) {
            if (data.type === 'MAP') {
                STATE.ring = data.ring;
                recalculateRing();
            } else if (data.type === 'OFFER') {
                logSys(`Recebida oferta WebRTC de ${data.from}`);
                await handleOffer(data);
            } else if (data.type === 'ANSWER') {
                const pc = STATE.peers[data.from];
                if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            } else if (data.type === 'ICE') {
                const pc = STATE.peers[data.from];
                if (pc) await pc.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(e => { });
            }
        }

        // --- TOPOLOGIA DIN√ÇMICA (ANEL + POLITE PEER) ---
        function recalculateRing() {
            const idx = STATE.ring.indexOf(STATE.id);
            if (idx === -1 || STATE.ring.length < 2) return;

            const nextId = STATE.ring[(idx + 1) % STATE.ring.length];

            if (STATE.currentNext !== nextId) {
                logSys(`Apontando conex√£o para: ${nextId}`);
                STATE.currentNext = nextId;
                // Polite Peer: O ID alfabeticamente maior inicia a oferta para evitar conflitos
                if (STATE.id > nextId) initWebRTC(nextId);
            }
        }

        async function initWebRTC(targetId) {
            const pc = createPC(targetId);
            const dc = pc.createDataChannel("ring-data");
            setupDC(dc, targetId);

            if (STATE.localStream) STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            sendSignal(targetId, { type: 'OFFER', sdp: offer });
        }

        async function handleOffer(data) {
            const pc = createPC(data.from);
            if (STATE.localStream) STATE.localStream.getTracks().forEach(t => pc.addTrack(t, STATE.localStream));
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendSignal(data.from, { type: 'ANSWER', sdp: answer });
        }

        function createPC(peerId) {
            if (STATE.peers[peerId]) STATE.peers[peerId].close();
            const pc = new RTCPeerConnection(RTC_CONF);
            STATE.peers[peerId] = pc;

            pc.onicecandidate = e => { if (e.candidate) sendSignal(peerId, { type: 'ICE', candidate: e.candidate }); };
            pc.ondatachannel = e => setupDC(e.channel, peerId);

            pc.ontrack = e => {
                addVideo(peerId, `Peer: ${peerId}`, e.streams[0]);
                // RELAY DE M√çDIA PEER-TO-PEER
                if (STATE.currentNext && STATE.currentNext !== peerId) {
                    const nextPC = STATE.peers[STATE.currentNext];
                    if (nextPC && nextPC.signalingState === 'stable') {
                        try { nextPC.addTrack(e.track, e.streams[0]); applyQuality(nextPC); } catch (err) { }
                    }
                }
            };

            pc.onconnectionstatechange = () => {
                const tag = document.getElementById('ring-status');
                if (pc.connectionState === 'connected') {
                    tag.innerText = "CONECTADO"; tag.style.color = "var(--success)";
                    logSys(`Link estabelecido com ${peerId}`);
                } else if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    tag.innerText = "OFFLINE"; tag.style.color = "var(--danger)";
                    healRing(peerId);
                }
            };
            return pc;
        }

        // --- RELAY DE DADOS E CHAT ---
        function setupDC(dc, peerId) {
            STATE.channels[peerId] = dc;
            dc.onmessage = e => {
                const data = JSON.parse(e.data);
                if (STATE.seen.has(data.uid)) return;
                STATE.seen.add(data.uid);
                appendMsg(data);
                relayData(data); // Repassa para o pr√≥ximo no anel
            };
        }

        function relayData(data) {
            if (STATE.currentNext) {
                const dc = STATE.channels[STATE.currentNext];
                if (dc && dc.readyState === 'open') dc.send(JSON.stringify(data));
            }
        }

        function broadcast(type, payload) {
            const data = { uid: Math.random().toString(36).substr(2, 9), origin: STATE.id, sender: STATE.name, type: type, ...payload };
            STATE.seen.add(data.uid);
            appendMsg(data);
            relayData(data);
        }

        // --- UI / MULTIM√çDIA ---
        function sendChat() {
            const el = document.getElementById('msg-input');
            if (!el.value) return;
            broadcast('chat', { text: el.value });
            el.value = '';
        }

        document.getElementById('msg-input').onpaste = (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf("image") !== -1) {
                    const reader = new FileReader();
                    reader.onload = (evt) => broadcast('img', { data: evt.target.result });
                    reader.readAsDataURL(item.getAsFile());
                }
            }
        };

        function sendFile(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return alert("M√°ximo 2MB");
            const reader = new FileReader();
            reader.onload = (e) => broadcast('file', { data: e.target.result, name: file.name });
            reader.readAsDataURL(file);
        }

        function appendMsg(msg) {
            const area = document.getElementById('chat-list');
            const div = document.createElement('div');
            div.className = 'm-item';
            let html = `<b>${msg.sender}:</b> `;
            if (msg.type === 'chat') html += `<span>${msg.text}</span>`;
            if (msg.type === 'img') html += `<img src="${msg.data}">`;
            if (msg.type === 'file') html += `<br><a href="${msg.data}" download="${msg.name}" style="color:var(--success); font-weight:bold; text-decoration:none;">üìÅ Baixar: ${msg.name}</a>`;
            div.innerHTML = html;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function addVideo(id, label, stream) {
            if (document.getElementById(`v-${id}`)) return;
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.id = `v-${id}`; div.className = 'v-item';
            div.innerHTML = `<video autoplay playsinline></video><div class="v-label">${label}</div>`;
            grid.appendChild(div);
            div.querySelector('video').srcObject = stream;
        }

        function applyQuality(pc) {
            const hops = STATE.ring.length;
            let fps = hops > 4 ? 5 : 15; // Degrada√ß√£o progressiva
            pc.getSenders().forEach(s => {
                if (s.track && s.track.kind === 'video') {
                    const p = s.getParameters();
                    if (!p.encodings) p.encodings = [{}];
                    p.encodings[0].maxFramerate = fps;
                    s.setParameters(p).catch(() => { });
                }
            });
        }

        function healRing(failedId) {
            STATE.ring = STATE.ring.filter(id => id !== failedId);
            const v = document.getElementById(`v-${failedId}`);
            if (v) v.remove();
            recalculateRing();
        }

        function refreshRing() {
            if (STATE.mqtt) STATE.mqtt.publish(`p2p_science_vfinal_fix_${STATE.room}/announce`, JSON.stringify({ type: 'JOIN', id: STATE.id }));
        }

        function sendSignal(to, payload) {
            payload.from = STATE.id;
            STATE.mqtt.publish(`p2p_science_vfinal_fix_${STATE.room}/direct/${to}`, JSON.stringify(payload));
        }

        function toggleMute(type) {
            if (!STATE.localStream) return;
            const t = type === 'audio' ? STATE.localStream.getAudioTracks()[0] : STATE.localStream.getVideoTracks()[0];
            if (t) {
                t.enabled = !t.enabled;
                logSys(`${type.toUpperCase()} ${t.enabled ? 'Ativado' : 'Desativado'}`);
            }
        }

        async function shareScreen() {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const t = s.getVideoTracks()[0];
                Object.values(STATE.peers).forEach(pc => {
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(t);
                });
                t.onended = () => {
                    const cam = STATE.localStream.getVideoTracks()[0];
                    Object.values(STATE.peers).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(cam);
                    });
                };
            } catch (e) { logSys("Falha ao compartilhar tela."); }
        }
    </script>
</body>

</html>
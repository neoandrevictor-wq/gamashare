<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gama Share - Mesh P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: #141414;
            --border-color: #2a2a2a;
            --gama-green: #00ff88;
            --gama-dark: #00cc6a;
            --danger: #ff4757;
            --text-main: #f1f1f1;
            --text-muted: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Modais */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8);
        }

        .modal h2 {
            color: var(--gama-green);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        /* Termos de Uso (Scrollbox Jur√≠dico) */
        .legal-box {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: justify;
        }

        .legal-box strong {
            color: #ddd;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--gama-green);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 6px;
            margin-bottom: 15px;
            outline: none;
            font-size: 1em;
        }

        input[type="text"]:focus {
            border-color: var(--gama-green);
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--gama-green);
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1em;
        }

        button:hover {
            background: var(--gama-dark);
        }

        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        button.btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        button.btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .readonly-id {
            background: #000;
            padding: 10px;
            border-radius: 6px;
            color: var(--gama-green);
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #333;
            letter-spacing: 1px;
        }

        /* App Layout */
        #app {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        header {
            padding: 12px 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--gama-green);
        }

        .room-badge {
            background: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-muted);
        }

        .room-badge:hover {
            border-color: var(--gama-green);
            color: white;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Grid de V√≠deo */
        #video-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: minmax(180px, 1fr);
            overflow-y: auto;
            align-content: start;
            background: #050505;
        }

        .video-card {
            position: relative;
            background: #111;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .peer-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Controles de Modera√ß√£o Descentralizada */
        .peer-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 8px;
            align-items: center;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-card:hover .peer-controls {
            opacity: 1;
        }

        .peer-controls button {
            width: auto;
            padding: 6px;
            font-size: 1em;
            margin: 0;
            background: transparent;
            color: white;
            border: none;
        }

        .peer-controls button:hover {
            color: var(--danger);
            background: rgba(255, 0, 0, 0.2);
            border-radius: 4px;
        }

        .peer-controls input[type="range"] {
            width: 60px;
            accent-color: var(--gama-green);
            cursor: pointer;
        }

        /* Sidebar (Chat / Logs / Arquivos) */
        #sidebar {
            width: 340px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        #chat-history {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 0.9em;
        }

        .msg {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
            word-break: break-word;
            border: 1px solid #222;
        }

        .msg strong {
            color: var(--gama-green);
            display: block;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .msg img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid #333;
        }

        .file-link {
            color: var(--gama-green);
            text-decoration: none;
            display: block;
            margin-top: 5px;
            font-weight: bold;
            background: #000;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px dashed var(--gama-green);
        }

        .file-link:hover {
            background: #050505;
        }

        /* Estilos dos LOGS */
        .log-msg {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8em;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 2px 0;
            background: #000;
            border-left: 3px solid #555;
            word-break: break-word;
        }

        .log-info {
            color: #8ab4f8;
            border-left-color: #8ab4f8;
        }

        .log-success {
            color: #81c995;
            border-left-color: #81c995;
        }

        .log-error {
            color: #f28b82;
            border-left-color: #f28b82;
        }

        .log-warn {
            color: #fde293;
            border-left-color: #fde293;
        }

        #controls-panel {
            padding: 15px;
            background: #0a0a0a;
            border-top: 1px solid var(--border-color);
        }

        .my-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .my-tools button {
            flex: 1;
            padding: 8px;
            font-size: 0.85em;
            background: #222;
            color: white;
        }

        .my-tools button.active {
            background: var(--gama-green);
            color: #000;
        }

        .chat-input-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .chat-input-box input {
            margin: 0;
            flex: 1;
        }

        .chat-input-box button {
            width: auto;
            padding: 0 15px;
            background: #222;
            color: white;
        }

        .chat-input-box button:hover {
            background: var(--gama-green);
            color: #000;
        }

        .btn-file {
            background: #111;
            border: 1px dashed #555;
            color: var(--text-muted);
            font-size: 0.85em;
            padding: 10px;
        }

        .btn-file:hover {
            border-color: var(--gama-green);
            color: white;
            background: #1a1a1a;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: 400px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
        }
    </style>
</head>

<body>

    <!-- Prote√ß√£o Jur√≠dica Forte (EULA) -->
    <div id="terms-overlay" class="overlay">
        <div class="modal">
            <h2>Termos e Licen√ßa de Uso (AS-IS)</h2>
            <div class="legal-box">
                <p><strong>LEIA ATENTAMENTE ANTES DE PROSSEGUIR:</strong></p>
                <p>O Gama Share √© um software experimental de c√≥digo-fonte aberto executado inteiramente no lado do
                    cliente (navegador). <strong>N√£o operamos servidores de banco de dados, armazenamento, roteamento de
                        m√≠dia (SFU/MCU) ou reten√ß√£o de registros.</strong></p>
                <p>1. <strong>Comunica√ß√£o Direta (P2P):</strong> Todo tr√°fego de √°udio, v√≠deo, texto e arquivos ocorre
                    atrav√©s de WebRTC diretamente entre o seu dispositivo e os dispositivos dos outros participantes da
                    sala.</p>
                <p>2. <strong>Isen√ß√£o de Responsabilidade Legal:</strong> O autor deste software atua exclusivamente
                    como desenvolvedor da ferramenta. Ao utiliz√°-la, voc√™ compreende e concorda que o autor n√£o possui
                    controle, acesso, monitoramento ou capacidade t√©cnica para intervir no conte√∫do trafegado. Voc√™
                    assume total e exclusiva responsabilidade civil e criminal pelo uso da plataforma e pelos dados que
                    transmitir ou receber.</p>
                <p>3. <strong>Aus√™ncia de Garantias:</strong> O software √© fornecido "COMO EST√Å" (AS-IS), sem garantias
                    de estabilidade, seguran√ßa contra intercepta√ß√µes locais em redes n√£o confi√°veis, ou adequa√ß√£o a um
                    prop√≥sito espec√≠fico.</p>
                <p>Ao concordar, voc√™ isenta permanentemente os criadores de qualquer lit√≠gio, dano ou consequ√™ncia
                    decorrente da utiliza√ß√£o desta ferramenta.</p>
            </div>
            <label class="checkbox-group" onclick="checkTerms()">
                <input type="checkbox" id="chk-terms">
                <span>Eu li, compreendo e assumo total responsabilidade legal.</span>
            </label>
            <button id="btn-accept-terms" disabled onclick="acceptTerms()">Prosseguir para o Sistema</button>
        </div>
    </div>

    <!-- Tela de Conex√£o (Setup e Logs Iniciais) -->
    <div id="join-overlay" class="overlay" style="display: none;">
        <div class="modal">
            <h2 id="join-title">Conectar √† Malha</h2>
            <p id="join-desc" style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 15px;"></p>

            <div id="room-display" class="readonly-id" style="display: none;"></div>

            <input type="text" id="nickname" placeholder="Seu Nickname de exibi√ß√£o" autocomplete="off" required>
            <button id="btn-connect" onclick="connectToMesh()">Iniciar Protocolo P2P</button>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app">
        <header>
            <div class="brand">üåê Gama Share</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="room-badge" id="top-room-id" onclick="copyRoomLink()" title="Clique para Copiar Link">üîó
                    Copiar Link da Sala</span>
                <button class="btn-danger" style="width: auto; padding: 6px 15px; font-size: 0.85em;"
                    onclick="location.href = window.location.pathname">Sair</button>
            </div>
        </header>

        <main>
            <div id="video-grid">
                <!-- V√≠deo Local -->
                <div class="video-card" id="card-local">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="peer-info">Voc√™ (<span id="my-nick-display"></span>)</div>
                </div>
            </div>

            <div id="sidebar">
                <div id="chat-history">
                    <div class="log-msg log-info">SISTEMA: Painel de Diagn√≥stico Inicializado.</div>
                </div>

                <div id="controls-panel">
                    <div class="my-tools">
                        <button id="btn-mic" class="active" onclick="toggleMic()">üéôÔ∏è Mic</button>
                        <button id="btn-cam" class="active" onclick="toggleCam()">üìπ Cam</button>
                        <button id="btn-screen" onclick="shareScreen()">üñ•Ô∏è Tela</button>
                    </div>
                    <div class="chat-input-box">
                        <input type="text" id="chat-input" placeholder="Mensagem... (Cole imagens com Ctrl+V)">
                        <button onclick="sendText()">Enviar</button>
                    </div>
                    <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
                    <button class="btn-file" onclick="document.getElementById('file-input').click()">üìÅ Compartilhar
                        Arquivo P2P</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        /** =========================================================================
         *  ESTADO GLOBAL E CONFIGURA√á√ïES
         *  ========================================================================= */
        const myId = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2);
        let myNickname = "An√¥nimo";
        let roomId = "";
        let isHost = false;

        let peer = null;
        let localStream = null;
        let screenStream = null;

        const connections = {}; // connections[peerId] = DataConnection
        const calls = {};       // calls[peerId] = MediaConnection
        const peersData = {};   // peersData[peerId] = "Nickname"

        let connectionRetries = 0;
        const MAX_RETRIES = 3;

        // Configura√ß√£o do PeerJS usando servidores STUN p√∫blicos livres do Google
        const peerConfig = {
            debug: 1, // Reduzido debug nativo para focarmos no nosso pr√≥prio Log
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        /** =========================================================================
         *  SISTEMA DE LOGS DE DIAGN√ìSTICO (INJETADO NO CHAT)
         *  ========================================================================= */
        const chatHist = document.getElementById('chat-history');

        function sysLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            chatHist.innerHTML += `<div class="log-msg log-${type}">[${time}] ${msg}</div>`;
            chatHist.scrollTop = chatHist.scrollHeight;
            console.log(`[GAMA ${type.toUpperCase()}] ${msg}`);
        }

        // Fun√ß√µes de Chat Normais
        function appendMsg(nick, txt) {
            chatHist.innerHTML += `<div class="msg"><strong>${nick}</strong>${txt}</div>`;
            chatHist.scrollTop = chatHist.scrollHeight;
        }
        function appendImg(nick, b64) {
            chatHist.innerHTML += `<div class="msg"><strong>${nick}</strong><img src="${b64}"></div>`;
            chatHist.scrollTop = chatHist.scrollHeight;
        }
        function appendFile(nick, name, blob) {
            const url = URL.createObjectURL(blob);
            chatHist.innerHTML += `<div class="msg"><strong>${nick} enviou arquivo:</strong><a class="file-link" href="${url}" download="${name}">üíæ Baixar ${name}</a></div>`;
            chatHist.scrollTop = chatHist.scrollHeight;
        }

        /** =========================================================================
         *  INICIALIZA√á√ÉO E UI
         *  ========================================================================= */
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('sala');

            if (!roomId) {
                isHost = true;
                // Cria um ID limpo para o Host
                roomId = "gama-" + Math.random().toString(36).substring(2, 10);
                document.getElementById('join-title').innerText = "Criar Sala Descentralizada";
                document.getElementById('join-desc').innerText = "Voc√™ ser√° o primeiro n√≥ da rede (Host L√≥gico). O ID da sala ser√° gerado automaticamente.";
            } else {
                isHost = false;
                // Limpa espa√ßos ou erros de URL
                roomId = roomId.trim();
                document.getElementById('join-title').innerText = "Entrar na Sala";
                document.getElementById('join-desc').innerText = "Protocolo cliente ativado. Preparando conex√£o P2P.";
                document.getElementById('room-display').style.display = 'block';
                document.getElementById('room-display').innerText = `ID ALVO: ${roomId}`;
            }
        };

        function checkTerms() {
            const isChecked = document.getElementById('chk-terms').checked;
            document.getElementById('btn-accept-terms').disabled = !isChecked;
        }

        function acceptTerms() {
            document.getElementById('terms-overlay').style.display = 'none';
            document.getElementById('join-overlay').style.display = 'flex';
            document.getElementById('nickname').focus();
        }

        function copyRoomLink() {
            const url = window.location.origin + window.location.pathname + "?sala=" + roomId;
            navigator.clipboard.writeText(url);
            const badge = document.getElementById('top-room-id');
            badge.innerText = "‚úÖ Link Copiado!";
            badge.style.color = "var(--gama-green)";
            setTimeout(() => {
                badge.innerText = "üîó Copiar Link da Sala";
                badge.style.color = "var(--text-muted)";
            }, 2000);
        }

        async function connectToMesh() {
            const nickInput = document.getElementById('nickname').value.trim();
            myNickname = nickInput || "An√¥nimo_" + Math.floor(Math.random() * 1000);
            peersData[myId] = myNickname;

            document.getElementById('btn-connect').disabled = true;
            document.getElementById('btn-connect').innerText = "Iniciando hardware...";

            await setupMedia();

            document.getElementById('join-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            window.history.pushState({ room: roomId }, "", `?sala=${roomId}`);
            document.getElementById('my-nick-display').innerText = myNickname;

            sysLog("Hardware acessado com sucesso.", "success");
            sysLog("Estabelecendo conex√£o com Tracker Global PeerJS...", "info");

            // Host usa o roomId fixo. Cliente deixa a nuvem gerar um UUID aleat√≥rio.
            peer = isHost ? new Peer(roomId, peerConfig) : new Peer(peerConfig);

            peer.on('open', id => {
                sysLog(`Conex√£o com Tracker estabelecida. Meu ID na nuvem: ${id}`, "success");

                if (isHost) {
                    sysLog(`SALA CRIADA: ${roomId}. Aguardando conex√µes P2P.`, "success");
                } else {
                    sysLog(`Buscando Host (${roomId}) na rede...`, "info");
                    connectToHostWithRetry();
                }
            });

            // Eventos Globais de Conex√£o Receptiva
            peer.on('connection', conn => {
                sysLog(`Recebendo requisi√ß√£o de dados de: ${conn.peer}`, "info");
                handleDataConnection(conn);
            });

            peer.on('call', call => {
                sysLog(`Recebendo stream de v√≠deo de: ${call.peer}`, "info");
                call.answer(localStream);
                handleMediaCall(call);
            });

            peer.on('error', err => {
                if (err.type === 'peer-unavailable') {
                    sysLog(`Falha: O n√≥ alvo (${err.message.split(' ')[2]}) n√£o foi encontrado.`, "error");
                } else if (err.type === 'network') {
                    sysLog(`Erro de rede: Perda de conex√£o com o sinalizador.`, "error");
                } else {
                    sysLog(`Erro PeerJS: ${err.type} - ${err.message}`, "error");
                }
                console.error(err);
            });
        }

        /** =========================================================================
         *  SISTEMA DE RETENTATIVAS PARA ENCONTRAR O HOST
         *  ========================================================================= */
        function connectToHostWithRetry() {
            // Se j√° conectou, aborta a retentativa
            if (connections[roomId] && connections[roomId].open) return;

            connectionRetries++;
            sysLog(`Tentativa de conex√£o com o Host ${connectionRetries}/${MAX_RETRIES}...`, "warn");

            const conn = peer.connect(roomId, { reliable: true });

            conn.on('open', () => {
                sysLog(`Conex√£o de dados com o Host estabelecida!`, "success");
                // Se os dados conectaram, iniciamos a chamada de m√≠dia imediatamente
                const call = peer.call(roomId, localStream);
                handleMediaCall(call);
            });

            handleDataConnection(conn);

            // Se ap√≥s 3 segundos a conex√£o n√£o abrir, tenta de novo
            setTimeout(() => {
                if (!connections[roomId] || !connections[roomId].open) {
                    if (connectionRetries < MAX_RETRIES) {
                        connectToHostWithRetry();
                    } else {
                        sysLog(`FALHA CR√çTICA: O Host (${roomId}) n√£o foi encontrado ou a sala foi encerrada. Recarregue a p√°gina e tente criar uma sala nova.`, "error");
                    }
                }
            }, 3000);
        }

        /** =========================================================================
         *  L√ìGICA DA MALHA P2P (FULL MESH)
         *  ========================================================================= */
        function initiateConnection(targetId) {
            if (connections[targetId] || targetId === peer.id) return;

            sysLog(`Iniciando conex√£o Mesh direta com o n√≥: ${targetId}`, "info");
            const conn = peer.connect(targetId);
            handleDataConnection(conn);

            conn.on('open', () => {
                sysLog(`Conectado ao n√≥ secund√°rio: ${targetId}`, "success");
                const call = peer.call(targetId, localStream);
                handleMediaCall(call);
            });
        }

        function handleDataConnection(conn) {
            connections[conn.peer] = conn;

            conn.on('open', () => {
                conn.send({ type: 'handshake', nickname: myNickname });
            });

            conn.on('data', data => {
                if (data.type === 'handshake') {
                    peersData[conn.peer] = data.nickname;
                    updateVideoCardNick(conn.peer);
                    sysLog(`Handshake conclu√≠do com ${data.nickname} (${conn.peer})`, "success");

                    // HOST atuando como Tracker L√≥gico para fechar a Malha
                    if (isHost) {
                        const otherPeers = Object.keys(connections).filter(id => id !== conn.peer);
                        if (otherPeers.length > 0) {
                            sysLog(`Enviando lista de ${otherPeers.length} peers para ${data.nickname}.`, "info");
                            conn.send({ type: 'mesh_bootstrap', peersList: otherPeers });
                        }
                        broadcastToOthers(conn.peer, { type: 'mesh_new_peer', newPeerId: conn.peer });
                    }
                }
                else if (data.type === 'mesh_bootstrap') {
                    sysLog(`Lista de Bootstrap recebida. Conectando a ${data.peersList.length} n√≥s existentes.`, "info");
                    data.peersList.forEach(peerId => initiateConnection(peerId));
                }
                else if (data.type === 'mesh_new_peer') {
                    sysLog(`Aviso do Host: Novo n√≥ na sala. Iniciando conex√£o com ${data.newPeerId}`, "info");
                    initiateConnection(data.newPeerId);
                }
                else if (data.type === 'chat') {
                    appendMsg(peersData[conn.peer] || 'An√¥nimo', data.text);
                }
                else if (data.type === 'image') {
                    appendImg(peersData[conn.peer] || 'An√¥nimo', data.base64);
                }
                else if (data.type === 'file') {
                    sysLog(`Recebendo arquivo de ${peersData[conn.peer]}: ${data.name}`, "info");
                    appendFile(peersData[conn.peer] || 'An√¥nimo', data.name, data.file);
                }
                else if (data.type === 'moderation') {
                    handleModeration(data, peersData[conn.peer]);
                }
            });

            conn.on('close', () => removePeer(conn.peer));
        }

        function handleMediaCall(call) {
            calls[call.peer] = call;

            call.on('stream', remoteStream => {
                if (!document.getElementById(`video-${call.peer}`)) {
                    createVideoCard(call.peer);
                }
                const videoEl = document.getElementById(`video-${call.peer}`);
                if (videoEl.srcObject !== remoteStream) {
                    videoEl.srcObject = remoteStream;
                    sysLog(`Stream de v√≠deo de ${peersData[call.peer] || call.peer} renderizado.`, "success");
                }
            });

            call.on('close', () => removePeer(call.peer));
            call.on('error', err => sysLog(`Erro de m√≠dia com ${call.peer}: ${err}`, "error"));
        }

        function removePeer(peerId) {
            if (connections[peerId]) delete connections[peerId];
            if (calls[peerId]) delete calls[peerId];

            const card = document.getElementById(`card-${peerId}`);
            if (card) {
                sysLog(`Conex√£o encerrada com: ${peersData[peerId] || peerId}`, "warn");
                card.remove();
                delete peersData[peerId];
            }
        }

        function broadcast(dataObj) {
            Object.values(connections).forEach(conn => {
                if (conn.open) conn.send(dataObj);
            });
        }

        function broadcastToOthers(exceptId, dataObj) {
            Object.values(connections).forEach(conn => {
                if (conn.open && conn.peer !== exceptId) conn.send(dataObj);
            });
        }

        /** =========================================================================
         *  M√çDIA E INTERFACE
         *  ========================================================================= */
        async function setupMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, frameRate: 24 }, audio: true });
                document.getElementById('local-video').srcObject = localStream;
            } catch (e) {
                sysLog("Erro de Hardware: C√¢mera ou Microfone n√£o encontrados ou bloqueados.", "error");
                localStream = new MediaStream(); // Fallback vazio para n√£o travar WebRTC
            }
        }

        function createVideoCard(peerId) {
            const div = document.createElement('div');
            div.className = 'video-card';
            div.id = `card-${peerId}`;

            div.innerHTML = `
            <video id="video-${peerId}" autoplay playsinline></video>
            <div class="peer-info" id="nick-${peerId}">Conectando...</div>
            <div class="peer-controls">
                <input type="range" min="0" max="1" step="0.1" value="1" title="Volume Pessoal" onchange="document.getElementById('video-${peerId}').volume = this.value">
                <button onclick="enforceModeration('${peerId}', 'mute')" title="Silenciar para todos">üîá</button>
                <button onclick="enforceModeration('${peerId}', 'hide')" title="Desativar c√¢mera para todos">üö´</button>
            </div>
        `;
            document.getElementById('video-grid').appendChild(div);
            updateVideoCardNick(peerId);
        }

        function updateVideoCardNick(peerId) {
            const el = document.getElementById(`nick-${peerId}`);
            if (el && peersData[peerId]) el.innerText = peersData[peerId];
        }

        // Ferramentas Locais
        function toggleMic() {
            const track = localStream?.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-mic');
                btn.className = track.enabled ? "active" : "";
                sysLog(`Microfone local ${track.enabled ? 'ativado' : 'desativado'}.`, "info");
            }
        }

        function toggleCam() {
            const track = localStream?.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-cam');
                btn.className = track.enabled ? "active" : "";
                sysLog(`C√¢mera local ${track.enabled ? 'ativada' : 'desativada'}.`, "info");
            }
        }

        async function shareScreen() {
            try {
                if (!screenStream) {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];

                    Object.values(calls).forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                        if (sender) sender.replaceTrack(screenTrack);
                    });

                    document.getElementById('local-video').srcObject = screenStream;
                    document.getElementById('btn-screen').className = "active";
                    sysLog("Compartilhamento de tela iniciado.", "success");

                    screenTrack.onended = () => stopScreenShare();
                } else {
                    stopScreenShare();
                }
            } catch (e) { sysLog("Compartilhamento de tela cancelado pelo usu√°rio.", "warn"); }
        }

        function stopScreenShare() {
            if (screenStream) screenStream.getTracks().forEach(t => t.stop());
            screenStream = null;

            const videoTrack = localStream?.getVideoTracks()[0];
            if (videoTrack) {
                Object.values(calls).forEach(call => {
                    const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                });
            }

            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('btn-screen').className = "";
            sysLog("Compartilhamento de tela encerrado.", "info");
        }

        /** =========================================================================
         *  MODERA√á√ÉO DESCENTRALIZADA (O Antigo "Anarquia")
         *  ========================================================================= */
        function enforceModeration(targetId, action) {
            broadcast({ type: 'moderation', target: targetId, action: action });
            sysLog(`Comando de modera√ß√£o (${action}) emitido globalmente para o n√≥ alvo.`, "warn");
        }

        function handleModeration(data, senderNick) {
            // CORRE√á√ÉO: Compara com o ID real da rede (peer.id) e n√£o o tempor√°rio
            if (data.target === peer.id) {
                if (data.action === 'mute') {
                    const track = localStream.getAudioTracks()[0];
                    if (track && track.enabled) toggleMic();
                    sysLog(`MODERA√á√ÉO: Seu microfone foi silenciado por ${senderNick || 'um usu√°rio'}.`, "warn");
                }
                else if (data.action === 'hide') {
                    const track = localStream.getVideoTracks()[0];
                    if (track && track.enabled) toggleCam();
                    sysLog(`MODERA√á√ÉO: Sua c√¢mera foi desativada por ${senderNick || 'um usu√°rio'}.`, "warn");
                }
            }
        }

        /** =========================================================================
         *  CHAT E ENTRADAS DE USU√ÅRIO
         *  ========================================================================= */
        function sendText() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if (txt) {
                appendMsg("Voc√™", txt);
                broadcast({ type: 'chat', text: txt });
                input.value = '';
            }
        }

        document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendText(); });

        document.getElementById('chat-input').addEventListener('paste', e => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = event => {
                        const b64 = event.target.result;
                        appendImg("Voc√™", b64);
                        broadcast({ type: 'image', base64: b64 });
                        sysLog("Imagem enviada para a malha.", "success");
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        function sendFile(input) {
            const file = input.files[0];
            if (!file) return;

            sysLog(`Lendo arquivo: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)...`, "info");

            if (file.size > 20 * 1024 * 1024) {
                sysLog("Aviso: Arquivos grandes podem causar instabilidade na conex√£o de dados do navegador.", "warn");
            }

            appendFile("Voc√™", file.name, file);
            broadcast({ type: 'file', name: file.name, file: file });

            sysLog("Arquivo despachado para os n√≥s conectados.", "success");
            input.value = '';
        }

    </script>
    Vers√£o 1.0.1 - contato:neoandrevictor@gmail.com - https://gamanext.vercel.app
</body>

</html>
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gama Share - Mesh P2P</title>
    <!-- Importa√ß√£o do motor de rede PeerJS (A mesma vers√£o est√°vel usada no jogo) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: #141414;
            --border-color: #222;
            --gama-green: #00ff88;
            --gama-dark: #00cc6a;
            --danger: #ff3333;
            --text-main: #f0f0f0;
            --text-muted: #888;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Overlays / Modais */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.1);
        }

        .modal h2 {
            color: var(--gama-green);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal p {
            color: var(--text-muted);
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 6px;
            margin-bottom: 15px;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: var(--gama-green);
        }

        button {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--gama-green);
            border: 1px solid var(--gama-green);
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }

        button:hover {
            background: var(--gama-green);
            color: #000;
        }

        button.btn-danger {
            color: var(--danger);
            border-color: var(--danger);
        }

        button.btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .readonly-id {
            background: #000;
            padding: 10px;
            border-radius: 6px;
            color: var(--gama-green);
            font-family: monospace;
            font-size: 0.85em;
            margin-bottom: 15px;
            word-break: break-all;
            border: 1px dashed #333;
        }

        /* App Layout */
        #app {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        header {
            padding: 15px 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--gama-green);
        }

        .room-badge {
            background: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.2s;
        }

        .room-badge:hover {
            border-color: var(--gama-green);
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Grid de V√≠deo */
        #video-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: minmax(200px, 1fr);
            overflow-y: auto;
            align-content: start;
        }

        .video-card {
            position: relative;
            background: #000;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            aspect-ratio: 16/9;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #050505;
        }

        .peer-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            backdrop-filter: blur(4px);
        }

        /* Controles An√°rquicos (Aparecem no Hover) */
        .anarchy-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 6px;
            align-items: center;
        }

        .video-card:hover .anarchy-controls {
            opacity: 1;
        }

        .anarchy-controls button {
            width: auto;
            padding: 4px 8px;
            font-size: 0.8em;
            margin: 0;
            background: transparent;
            color: white;
            border: none;
        }

        .anarchy-controls button:hover {
            color: var(--danger);
            background: transparent;
        }

        .anarchy-controls input[type="range"] {
            width: 60px;
            accent-color: var(--gama-green);
            cursor: pointer;
        }

        /* Sidebar (Chat / Arquivos) */
        #sidebar {
            width: 320px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        #chat-history {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            word-break: break-word;
        }

        .msg strong {
            color: var(--gama-green);
            display: block;
            margin-bottom: 4px;
        }

        .msg img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid #333;
        }

        .sys-msg {
            color: var(--text-muted);
            font-size: 0.75em;
            text-align: center;
            font-style: italic;
        }

        .file-link {
            color: var(--gama-green);
            text-decoration: none;
            display: block;
            margin-top: 5px;
            font-weight: bold;
        }

        #controls-panel {
            padding: 15px;
            background: #0d0d0d;
            border-top: 1px solid var(--border-color);
        }

        .my-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .my-tools button {
            flex: 1;
            padding: 8px;
            font-size: 0.8em;
        }

        .my-tools button.active {
            background: var(--gama-green);
            color: #000;
        }

        .chat-input-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .chat-input-box input {
            margin: 0;
            flex: 1;
        }

        .chat-input-box button {
            width: auto;
            padding: 0 15px;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: 350px;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
        }
    </style>
</head>

<body>

    <!-- Prote√ß√£o Jur√≠dica -->
    <div id="terms-overlay" class="overlay">
        <div class="modal">
            <h2>Termos de Uso</h2>
            <p>Este √© um experimento cient√≠fico de rede Mesh P2P. <strong>N√£o existem servidores de m√≠dia.</strong></p>
            <p>Tudo o que trafega (v√≠deo, √°udio, textos, arquivos) vai diretamente do seu navegador para os navegadores
                dos outros participantes na sala via tecnologia WebRTC.</p>
            <p>Ao entrar, voc√™ assume total responsabilidade pelo uso. O autor do software n√£o tem acesso √† sala.</p>
            <button onclick="acceptTerms()">Concordo e Aceito</button>
        </div>
    </div>

    <!-- Tela de Conex√£o -->
    <div id="join-overlay" class="overlay" style="display: none;">
        <div class="modal">
            <h2 id="join-title">Gama Share</h2>
            <p id="join-desc">Iniciando protocolo de conex√£o P2P.</p>
            <div id="room-display" class="readonly-id" style="display: none;"></div>
            <input type="text" id="nickname" placeholder="Digite seu Nickname" autocomplete="off" required>
            <button id="btn-connect" onclick="connectToMesh()">Conectar √† Malha</button>
            <div id="conn-status"
                style="margin-top: 10px; font-size: 0.8em; color: var(--gama-green); text-align: center;"></div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app">
        <header>
            <div class="brand">üåê Gama Share</div>
            <div>
                <span class="room-badge" id="top-room-id" onclick="copyRoomLink()" title="Copiar Link"></span>
                <button class="btn-danger" style="width: auto; padding: 6px 15px; margin-left: 10px; border:none;"
                    onclick="location.href = window.location.pathname">Sair</button>
            </div>
        </header>

        <main>
            <div id="video-grid">
                <!-- V√≠deo Local -->
                <div class="video-card" id="card-local">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="peer-info">Voc√™ (<span id="my-nick-display"></span>)</div>
                </div>
            </div>

            <div id="sidebar">
                <div id="chat-history">
                    <div class="sys-msg">Bem-vindo ao P2P. Cole imagens ou envie arquivos. Nada √© salvo.</div>
                </div>

                <div id="controls-panel">
                    <div class="my-tools">
                        <button id="btn-mic" class="active" onclick="toggleMic()">üéôÔ∏è Mic</button>
                        <button id="btn-cam" class="active" onclick="toggleCam()">üìπ Cam</button>
                        <button id="btn-screen" onclick="shareScreen()">üñ•Ô∏è Tela</button>
                    </div>
                    <div class="chat-input-box">
                        <input type="text" id="chat-input" placeholder="Mensagem... (Cole imagens)">
                        <button onclick="sendText()">‚û§</button>
                    </div>
                    <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
                    <button style="border-style: dashed; color: var(--text-muted);"
                        onclick="document.getElementById('file-input').click()">üìÅ Compartilhar Arquivo</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        /** =========================================================================
         *  ESTADO GLOBAL
         *  ========================================================================= */
        const myId = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2);
        let myNickname = "An√¥nimo";
        let roomId = "";
        let isHost = false;

        let peer = null;
        let localStream = null;
        let screenStream = null;

        // Dicion√°rios para manter a malha Full Mesh
        const connections = {}; // Armazena conex√µes de dados: connections[peerId]
        const calls = {};       // Armazena chamadas de m√≠dia: calls[peerId]
        const peersData = {};   // Armazena os nicks: peersData[peerId] = nickname

        /** =========================================================================
         *  INICIALIZA√á√ÉO E UI
         *  ========================================================================= */
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('sala');

            if (!roomId) {
                // Eu sou o Host
                isHost = true;
                roomId = "gama-" + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2));
                document.getElementById('join-title').innerText = "Criar Nova Sala";
                document.getElementById('join-desc').innerText = "Voc√™ ser√° o primeiro n√≥ da rede (Host).";
            } else {
                // Eu sou Cliente
                isHost = false;
                document.getElementById('join-title').innerText = "Entrar na Sala";
                document.getElementById('join-desc').innerText = "Conectando ao Tracker do Host...";
                document.getElementById('room-display').style.display = 'block';
                document.getElementById('room-display').innerText = `ID: ${roomId}`;
            }
        };

        function acceptTerms() {
            document.getElementById('terms-overlay').style.display = 'none';
            document.getElementById('join-overlay').style.display = 'flex';
            document.getElementById('nickname').focus();
        }

        function copyRoomLink() {
            const url = window.location.origin + window.location.pathname + "?sala=" + roomId;
            navigator.clipboard.writeText(url);
            const badge = document.getElementById('top-room-id');
            const orig = badge.innerText;
            badge.innerText = "Copiado!";
            setTimeout(() => badge.innerText = orig, 2000);
        }

        async function connectToMesh() {
            const nickInput = document.getElementById('nickname').value.trim();
            myNickname = nickInput || "An√¥nimo_" + Math.floor(Math.random() * 1000);
            peersData[myId] = myNickname;

            document.getElementById('btn-connect').disabled = true;
            document.getElementById('conn-status').innerText = "Acessando perif√©ricos...";

            await setupMedia();

            document.getElementById('conn-status').innerText = "Negociando com PeerJS Cloud...";

            // --- A M√ÅGICA ACONTECE AQUI ---
            // Se eu sou o Host, eu for√ßo meu ID do PeerJS a ser o RoomID.
            // Se sou Cliente, deixo o PeerJS gerar um ID aleat√≥rio para mim.
            const peerConfig = { config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }] } };
            peer = isHost ? new Peer(roomId, peerConfig) : new Peer(peerConfig);

            peer.on('open', id => {
                // Atualiza a interface e a URL
                document.getElementById('join-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                window.history.pushState({ room: roomId }, "", `?sala=${roomId}`);
                document.getElementById('top-room-id').innerText = `üîó Sala: ${roomId.split('-')[1] || roomId.substring(0, 6)}...`;
                document.getElementById('my-nick-display').innerText = myNickname;

                sysMsg(isHost ? "Sala criada. Aguardando peers." : "Conectado √† nuvem. Buscando Host...");

                if (!isHost) {
                    // Se sou Cliente, me conecto ao Host usando o RoomID
                    initiateConnection(roomId);
                }
            });

            // Quando ALGU√âM se conecta a mim (Dados)
            peer.on('connection', conn => {
                handleDataConnection(conn);
            });

            // Quando ALGU√âM me liga (V√≠deo/√Åudio)
            peer.on('call', call => {
                call.answer(localStream); // Atendo enviando minha c√¢mera
                handleMediaCall(call);
            });

            peer.on('error', err => {
                console.error(err);
                if (err.type === 'peer-unavailable') {
                    alert("O Host n√£o foi encontrado. A sala pode ter sido encerrada.");
                    location.href = window.location.pathname;
                }
            });

            // Loop de auto-degrada√ß√£o da qualidade (Mosaico)
            setInterval(adaptQuality, 10000);
        }

        /** =========================================================================
         *  L√ìGICA DA MALHA P2P (FULL MESH ROTEADA)
         *  ========================================================================= */
        function initiateConnection(targetId) {
            if (connections[targetId] || targetId === peer.id) return;

            const conn = peer.connect(targetId);
            handleDataConnection(conn);

            // Assim que conectar dados, eu ligo em v√≠deo para a pessoa
            conn.on('open', () => {
                const call = peer.call(targetId, localStream);
                handleMediaCall(call);
            });
        }

        function handleDataConnection(conn) {
            connections[conn.peer] = conn;

            conn.on('open', () => {
                // Sempre que conecto, envio meu nick
                conn.send({ type: 'handshake', nickname: myNickname });
            });

            conn.on('data', data => {
                // Handshake (Troca de Nomes)
                if (data.type === 'handshake') {
                    peersData[conn.peer] = data.nickname;
                    updateVideoCardNick(conn.peer);

                    // Se EU sou o Host, eu atuo como roteador da malha (Mesh Bootstrap)
                    if (isHost) {
                        // Envio para o novo peer a lista de TODOS os outros que j√° est√£o na sala
                        const otherPeers = Object.keys(connections).filter(id => id !== conn.peer);
                        conn.send({ type: 'mesh_bootstrap', peersList: otherPeers });

                        // Aviso os antigos sobre o novo peer
                        broadcastToOthers(conn.peer, { type: 'mesh_new_peer', newPeerId: conn.peer });
                    }
                }
                // Recebendo lista do Host para me conectar aos outros
                else if (data.type === 'mesh_bootstrap') {
                    data.peersList.forEach(peerId => initiateConnection(peerId));
                }
                // Recebendo aviso do Host que algu√©m novo entrou
                else if (data.type === 'mesh_new_peer') {
                    initiateConnection(data.newPeerId);
                }
                // Funcionalidades da Sala
                else if (data.type === 'chat') {
                    appendMsg(peersData[conn.peer] || 'An√¥nimo', data.text);
                }
                else if (data.type === 'image') {
                    appendImg(peersData[conn.peer] || 'An√¥nimo', data.base64);
                }
                else if (data.type === 'file') {
                    // PeerJS suporta envio nativo de Blob/ArrayBuffer \o/
                    appendFile(peersData[conn.peer] || 'An√¥nimo', data.name, data.file);
                }
                else if (data.type === 'anarchy') {
                    handleAnarchy(data, peersData[conn.peer]);
                }
            });

            conn.on('close', () => removePeer(conn.peer));
        }

        function handleMediaCall(call) {
            calls[call.peer] = call;

            call.on('stream', remoteStream => {
                if (!document.getElementById(`video-${call.peer}`)) {
                    createVideoCard(call.peer);
                }
                const videoEl = document.getElementById(`video-${call.peer}`);
                // Evita flickering setando o srcObject apenas se for novo
                if (videoEl.srcObject !== remoteStream) {
                    videoEl.srcObject = remoteStream;
                }
            });

            call.on('close', () => removePeer(call.peer));
        }

        function removePeer(peerId) {
            if (connections[peerId]) delete connections[peerId];
            if (calls[peerId]) delete calls[peerId];

            const card = document.getElementById(`card-${peerId}`);
            if (card) {
                sysMsg(`${peersData[peerId] || 'Um usu√°rio'} saiu da rede.`);
                card.remove();
                delete peersData[peerId];
            }
        }

        function broadcast(dataObj) {
            Object.values(connections).forEach(conn => {
                if (conn.open) conn.send(dataObj);
            });
        }

        function broadcastToOthers(exceptId, dataObj) {
            Object.values(connections).forEach(conn => {
                if (conn.open && conn.peer !== exceptId) conn.send(dataObj);
            });
        }

        /** =========================================================================
         *  M√çDIA E DEGRADA√á√ÉO (MOSAICO)
         *  ========================================================================= */
        async function setupMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, frameRate: 24 }, audio: true });
                document.getElementById('local-video').srcObject = localStream;
            } catch (e) {
                console.warn("Sem c√¢mera/mic. Funcionalidade reduzida.");
                localStream = new MediaStream(); // Stream vazio pra n√£o quebrar liga√ß√µes
            }
        }

        async function adaptQuality() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;

            const count = Object.keys(connections).length;
            try {
                if (count > 6) { await videoTrack.applyConstraints({ width: 160, height: 120, frameRate: 10 }); } // Mosaico Extremo
                else if (count > 3) { await videoTrack.applyConstraints({ width: 320, height: 240, frameRate: 15 }); } // Mosaico Leve
                else { await videoTrack.applyConstraints({ width: 640, height: 480, frameRate: 24 }); } // Padr√£o
            } catch (e) { }
        }

        /** =========================================================================
         *  CONTROLES LOCAIS E ANARQUIA GLOBAL
         *  ========================================================================= */
        function createVideoCard(peerId) {
            const div = document.createElement('div');
            div.className = 'video-card';
            div.id = `card-${peerId}`;

            div.innerHTML = `
            <video id="video-${peerId}" autoplay playsinline></video>
            <div class="peer-info" id="nick-${peerId}">Conectando...</div>
            <div class="anarchy-controls">
                <input type="range" min="0" max="1" step="0.1" value="1" title="Volume Local" onchange="document.getElementById('video-${peerId}').volume = this.value">
                <button onclick="enforceAnarchy('${peerId}', 'mute')" title="For√ßar Mute">üîá</button>
                <button onclick="enforceAnarchy('${peerId}', 'hide')" title="For√ßar Hide">üö´</button>
            </div>
        `;
            document.getElementById('video-grid').appendChild(div);
            updateVideoCardNick(peerId);
        }

        function updateVideoCardNick(peerId) {
            const el = document.getElementById(`nick-${peerId}`);
            if (el && peersData[peerId]) el.innerText = peersData[peerId];
        }

        // Ferramentas Locais
        function toggleMic() {
            const track = localStream?.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-mic');
                btn.className = track.enabled ? "active" : "";
            }
        }

        function toggleCam() {
            const track = localStream?.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById('btn-cam');
                btn.className = track.enabled ? "active" : "";
            }
        }

        async function shareScreen() {
            try {
                if (!screenStream) {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];

                    // Substitui a track nas chamadas do PeerJS
                    Object.values(calls).forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                        if (sender) sender.replaceTrack(screenTrack);
                    });

                    document.getElementById('local-video').srcObject = screenStream;
                    document.getElementById('btn-screen').className = "active";
                    document.getElementById('btn-screen').innerText = "üñ•Ô∏è Parar";

                    screenTrack.onended = () => stopScreenShare();
                } else {
                    stopScreenShare();
                }
            } catch (e) { console.error("Screen share cancelado."); }
        }

        function stopScreenShare() {
            if (screenStream) screenStream.getTracks().forEach(t => t.stop());
            screenStream = null;

            const videoTrack = localStream?.getVideoTracks()[0];
            if (videoTrack) {
                Object.values(calls).forEach(call => {
                    const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                });
            }

            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('btn-screen').className = "";
            document.getElementById('btn-screen').innerText = "üñ•Ô∏è Tela";
        }

        // Anarquia
        function enforceAnarchy(targetId, action) {
            // Envia o comando an√°rquico via P2P
            broadcast({ type: 'anarchy', target: targetId, action: action });
            sysMsg(`Aviso: Ordem de censura enviada para o n√≥ selecionado.`);
        }

        function handleAnarchy(data, senderNick) {
            // Se a ordem for pra mim, eu devo obedecer
            if (data.target === myId) {
                if (data.action === 'mute') {
                    const track = localStream.getAudioTracks()[0];
                    if (track && track.enabled) toggleMic(); // Desliga
                    sysMsg(`üö® O usu√°rio ${senderNick || 'An√¥nimo'} for√ßou o mute no seu microfone.`);
                }
                else if (data.action === 'hide') {
                    const track = localStream.getVideoTracks()[0];
                    if (track && track.enabled) toggleCam(); // Desliga
                    sysMsg(`üö® O usu√°rio ${senderNick || 'An√¥nimo'} for√ßou o desligamento da sua c√¢mera.`);
                }
            }
        }

        /** =========================================================================
         *  CHAT, IMAGENS E ARQUIVOS (Dados P2P)
         *  ========================================================================= */
        const hist = document.getElementById('chat-history');

        function sysMsg(txt) {
            hist.innerHTML += `<div class="sys-msg">${txt}</div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        function appendMsg(nick, txt) {
            hist.innerHTML += `<div class="msg"><strong>${nick}</strong>${txt}</div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        function appendImg(nick, b64) {
            hist.innerHTML += `<div class="msg"><strong>${nick}</strong><img src="${b64}"></div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        function appendFile(nick, name, blob) {
            const url = URL.createObjectURL(blob);
            hist.innerHTML += `<div class="msg"><strong>${nick} enviou arquivo:</strong><a class="file-link" href="${url}" download="${name}">üíæ Baixar ${name}</a></div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        function sendText() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if (txt) {
                appendMsg("Voc√™", txt);
                broadcast({ type: 'chat', text: txt });
                input.value = '';
            }
        }

        document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendText(); });

        // Colar Imagem (Ctrl+V)
        document.getElementById('chat-input').addEventListener('paste', e => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = event => {
                        const b64 = event.target.result;
                        appendImg("Voc√™", b64);
                        broadcast({ type: 'image', base64: b64 });
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        // Envio de Arquivo (PeerJS suporta envio de Blob nativo)
        function sendFile(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 20 * 1024 * 1024) { // Limite de 20MB sugerido para n√£o estourar RAM
                alert("Evite enviar arquivos maiores que 20MB para manter a estabilidade da malha.");
            }

            sysMsg(`Enviando arquivo: ${file.name}...`);

            // Exibe localmente
            appendFile("Voc√™", file.name, file);

            // Envia P2P via PeerJS
            broadcast({ type: 'file', name: file.name, file: file });

            input.value = '';
        }

    </script>
</body>

</html>
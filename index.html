<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gama Share - P2P Descentralizado</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-bg: #1a1a1a;
            --border-color: #2a2a2a;
            --primary: #00ff88;
            --primary-hover: #00cc6a;
            --danger: #ff4757;
            --danger-hover: #ff2e43;
            --text: #f1f1f1;
            --text-muted: #888;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Modals e Overlays */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--panel-bg); padding: 40px; border-radius: 12px;
            border: 1px solid var(--border-color); width: 90%; max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7); text-align: center;
        }
        .modal-content h2 { margin-bottom: 10px; color: var(--primary); font-size: 1.8em; }
        .modal-content h3 { margin-bottom: 20px; color: var(--text); font-weight: normal; font-size: 1.1em; }
        .modal-content p { margin-bottom: 20px; font-size: 0.9em; line-height: 1.6; color: var(--text-muted); text-align: left; }
        
        input[type="text"] {
            width: 100%; padding: 12px 15px; margin-bottom: 20px;
            background: #000; border: 1px solid var(--border-color); color: white;
            border-radius: 6px; outline: none; font-size: 1em; transition: border 0.3s;
        }
        input[type="text"]:focus { border-color: var(--primary); }
        
        button {
            background: var(--primary); color: #000; border: none; padding: 12px 20px;
            cursor: pointer; border-radius: 6px; font-weight: bold; width: 100%;
            font-size: 1em; transition: all 0.2s;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button.danger { background: var(--danger); color: white; }
        button.danger:hover { background: var(--danger-hover); }

        .readonly-room {
            background: #000; padding: 10px; border-radius: 6px; color: var(--primary);
            font-family: monospace; font-size: 0.9em; margin-bottom: 20px; word-break: break-all;
        }

        /* Layout Principal */
        #app { display: none; flex: 1; flex-direction: column; height: 100%; }
        header {
            padding: 15px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-size: 1.2em; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px;}
        .room-info { 
            font-size: 0.85em; color: var(--text-muted); background: #000; 
            padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s;
            border: 1px solid var(--border-color);
        }
        .room-info:hover { color: var(--text); border-color: var(--primary); }
        
        main { display: flex; flex: 1; overflow: hidden; }
        
        /* Grid de V√≠deos */
        #video-container {
            flex: 1; padding: 15px; display: grid; gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: minmax(180px, 1fr);
            overflow-y: auto; align-content: start;
        }
        .video-card {
            position: relative; background: #000; border-radius: 10px; overflow: hidden;
            border: 1px solid var(--border-color); aspect-ratio: 16/9; display: flex;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        video { width: 100%; height: 100%; object-fit: cover; background: #050505; }
        .peer-name {
            position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7);
            padding: 4px 10px; border-radius: 6px; font-size: 0.85em; backdrop-filter: blur(4px);
        }
        
        /* Controles An√°rquicos (Aparecem no hover) */
        .peer-controls {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 8px;
            opacity: 0; transition: opacity 0.3s; background: rgba(0,0,0,0.6);
            padding: 6px; border-radius: 8px; backdrop-filter: blur(4px);
            align-items: center;
        }
        .video-card:hover .peer-controls { opacity: 1; }
        .peer-controls button { 
            padding: 6px; width: auto; font-size: 1em; margin: 0; background: transparent; 
            color: white; border-radius: 4px; border: 1px solid transparent;
        }
        .peer-controls button:hover { background: rgba(255,255,255,0.2); }
        .peer-controls input[type="range"] { 
            width: 60px; accent-color: var(--primary); cursor: pointer;
        }

        /* Sidebar (Chat e Arquivos) */
        #sidebar {
            width: 320px; background: var(--panel-bg); border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        #chat-history {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }
        .message { font-size: 0.9em; background: #222; padding: 10px; border-radius: 8px; word-break: break-word;}
        .message strong { color: var(--primary); display: block; margin-bottom: 3px; font-size: 0.9em;}
        .message img { max-width: 100%; margin-top: 8px; border-radius: 6px; border: 1px solid #333; }
        .system-msg { color: var(--text-muted); font-style: italic; font-size: 0.8em; text-align: center; }
        .file-link { color: var(--primary); text-decoration: none; font-weight: bold; display: block; margin-top: 5px;}
        .file-link:hover { text-decoration: underline; }
        
        #controls-panel { padding: 15px; background: #111; border-top: 1px solid var(--border-color); }
        .my-controls { display: flex; gap: 8px; margin-bottom: 12px;}
        .my-controls button { padding: 8px; font-size: 0.85em; flex: 1; margin: 0; background: #333; color: white;}
        .my-controls button:hover { background: #444; }
        .my-controls button.active { background: var(--primary); color: #000; }
        
        .chat-input-area { display: flex; gap: 8px; margin-bottom: 10px;}
        #chat-input { margin-bottom: 0; flex: 1; font-size: 0.9em; padding: 10px; border-radius: 20px;}
        .chat-input-area button { width: auto; margin:0; padding: 0 15px; border-radius: 20px;}
        
        .file-btn { background: #222; border: 1px dashed var(--border-color); color: var(--text-muted); font-size: 0.85em;}
        .file-btn:hover { background: #2a2a2a; border-color: var(--primary); color: var(--text);}

        @media (max-width: 768px) {
            main { flex-direction: column; }
            #sidebar { width: 100%; height: 350px; border-left: none; border-top: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>

    <!-- Modal de Termos -->
    <div id="terms-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Gama Share</h2>
            <h3>Termos de Utiliza√ß√£o</h3>
            <p>Este √© um artefato de software experimental e educacional de rede P2P Mesh descentralizada.</p>
            <p><strong>N√£o existem servidores centrais.</strong> C√¢mera, microfone, arquivos e textos trafegam diretamente entre os dispositivos conectados usando WebRTC. A p√°gina funciona localmente e n√£o armazena nenhum dado.</p>
            <p>Ao prosseguir, voc√™ compreende que o autor n√£o possui controle, acesso ou responsabilidade legal sobre o uso da ferramenta ou dados trafegados.</p>
            <button onclick="acceptTerms()">Concordo e Aceito</button>
        </div>
    </div>

    <!-- Modal de Entrada (Criar/Entrar) -->
    <div id="join-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="join-title">Gama Share</h2>
            <p id="join-desc" style="text-align: center; margin-bottom: 10px;"></p>
            
            <div id="room-display-box" class="readonly-room" style="display: none;"></div>
            
            <input type="text" id="nickname" placeholder="Digite seu Nickname" required autocomplete="off">
            <button id="btn-join-action" onclick="executeJoin()"></button>
        </div>
    </div>

    <!-- Interface Principal -->
    <div id="app">
        <header>
            <div class="brand">
                <span>üåê</span> Gama Share
                <span class="room-info" id="top-room-id" onclick="copyRoomLink()" title="Clique para copiar o link"></span>
            </div>
            <div>
                <button class="danger" style="width: auto; padding: 8px 15px; margin: 0; font-size: 0.85em;" onclick="location.href = window.location.pathname">Sair da Sala</button>
            </div>
        </header>

        <main>
            <div id="video-container">
                <!-- V√≠deo Local -->
                <div class="video-card" id="card-local">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="peer-name">Voc√™ (<span id="local-nick-display"></span>)</div>
                </div>
            </div>

            <div id="sidebar">
                <div id="chat-history">
                    <div class="system-msg">Bem-vindo ao Gama Share.<br>Tudo aqui √© P2P e descentralizado. Cole imagens diretamente no campo de texto abaixo.</div>
                </div>
                
                <div id="controls-panel">
                    <div class="my-controls">
                        <button onclick="toggleMic()" id="btn-mic" class="active">üéôÔ∏è Mic On</button>
                        <button onclick="toggleCam()" id="btn-cam" class="active">üìπ Cam On</button>
                        <button onclick="shareScreen()" id="btn-screen">üñ•Ô∏è Tela</button>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Mensagem... (Cole imagens)">
                        <button onclick="sendText()">‚û§</button>
                    </div>
                    <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
                    <button class="file-btn" onclick="document.getElementById('file-input').click()">üìÅ Compartilhar Arquivo P2P</button>
                </div>
            </div>
        </main>
    </div>

<script>
    /* ======================================================================
       ESTADO GLOBAL E CONFIGURA√á√ïES
       ====================================================================== */
    const myId = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2) + Date.now().toString(36);
    let myNickname = "An√¥nimo";
    let roomId = "";
    let isCreatingRoom = false;
    
    let localStream = null;
    let screenStream = null;
    const peers = {}; // peers[id] = { connection, dataChannel, lastHeartbeat }
    
    const CHUNK_SIZE = 16384; // 16KB para envio eficiente via DataChannel WebRTC

    // Servidores STUN p√∫blicos livres do Google
    const webrtcConfig = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" }
        ]
    };

    // Servidor WebSocket global para Bootstrap inicial (Apenas troca de chaves IP/SDP)
    // Utilizamos um public broker livre.
    const SIGNALING_SERVER = "wss://free.blr2.piesocket.com/v3/1?api_key=O31hMDb2N0UrtwE1w73d32z63R7l3N39mD4o1a3P";
    let ws = null;

    /* ======================================================================
       L√ìGICA DE INICIALIZA√á√ÉO E UI
       ====================================================================== */
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('sala');

        if (!roomId) {
            // Modo Cria√ß√£o
            isCreatingRoom = true;
            roomId = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2);
            document.getElementById('join-title').innerText = "Criar Nova Sala";
            document.getElementById('join-desc').innerText = "Voc√™ est√° criando um ambiente seguro P2P.";
            document.getElementById('btn-join-action').innerText = "Criar e Entrar";
        } else {
            // Modo Entrada
            isCreatingRoom = false;
            document.getElementById('join-title').innerText = "Entrar na Sala";
            document.getElementById('join-desc').innerText = "Voc√™ foi convidado. Insira seu nome para conectar.";
            document.getElementById('room-display-box').style.display = 'block';
            document.getElementById('room-display-box').innerText = `ID: ${roomId}`;
            document.getElementById('btn-join-action').innerText = "Conectar";
        }
    };

    function acceptTerms() {
        document.getElementById('terms-modal').style.display = 'none';
        document.getElementById('join-modal').style.display = 'flex';
        document.getElementById('nickname').focus();
    }

    async function executeJoin() {
        const nickInput = document.getElementById('nickname').value.trim();
        myNickname = nickInput || "An√¥nimo_" + Math.floor(Math.random()*1000);

        document.getElementById('join-modal').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        
        // Atualiza a URL dinamicamente sem recarregar a p√°gina
        window.history.pushState({room: roomId}, "Gama Share", `?sala=${roomId}`);
        
        document.getElementById('top-room-id').innerText = `üîó ID: ${roomId.split('-')[0]}... (Copiar)`;
        document.getElementById('local-nick-display').innerText = myNickname;

        await setupMedia();
        connectSignaling();
        
        // Loops de estabilidade de rede
        setInterval(checkNetworkHealth, 5000);
        setInterval(sendHeartbeat, 3000);
    }

    function copyRoomLink() {
        const url = window.location.origin + window.location.pathname + "?sala=" + roomId;
        navigator.clipboard.writeText(url);
        
        const btn = document.getElementById('top-room-id');
        const originalText = btn.innerText;
        btn.innerText = "‚úÖ Link Copiado!";
        btn.style.color = "var(--primary)";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.color = "var(--text-muted)";
        }, 2000);
    }

    /* ======================================================================
       M√çDIA E DEGRADA√á√ÉO PROGRESSIVA (MOSAICO)
       ====================================================================== */
    async function setupMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480, frameRate: 24 }, 
                audio: true 
            });
            document.getElementById('local-video').srcObject = localStream;
        } catch (e) {
            console.warn("Acesso √† c√¢mera/mic negado ou inexistente. Modo ouvinte ativado.");
            // Cria um stream vazio para n√£o quebrar a l√≥gica do WebRTC
            localStream = new MediaStream(); 
        }
    }

    async function adaptQuality() {
        if(!localStream) return;
        const videoTrack = localStream.getVideoTracks()[0];
        if(!videoTrack) return;

        const peerCount = Object.keys(peers).length;
        try {
            if (peerCount > 6) {
                // Degrada√ß√£o para Mosaico pesado
                await videoTrack.applyConstraints({ width: 160, height: 120, frameRate: 10 });
                addSystemMsg("Rede densa: Resolu√ß√£o de v√≠deo reduzida (Auto-Degrada√ß√£o).");
            } else if (peerCount > 3) {
                // Degrada√ß√£o leve
                await videoTrack.applyConstraints({ width: 320, height: 240, frameRate: 15 });
            } else {
                // Padr√£o
                await videoTrack.applyConstraints({ width: 640, height: 480, frameRate: 24 });
            }
        } catch(e) { /* Navegadores mobile podem ignorar constraints */ }
    }

    /* ======================================================================
       SINALIZA√á√ÉO VIA WEBSOCKET P√öBLICO
       ====================================================================== */
    function connectSignaling() {
        ws = new WebSocket(SIGNALING_SERVER);
        
        ws.onopen = () => {
            addSystemMsg("Conectado ao Tracker Global. Buscando peers na sala...");
            ws.send(JSON.stringify({ type: 'join', room: roomId, sender: myId }));
        };

        ws.onmessage = async (event) => {
            try {
                const msg = JSON.parse(event.data);
                
                // Isolamento de Sala L√≥gica: S√≥ processa mensagens desta exata sala.
                if (msg.room !== roomId || msg.sender === myId) return;

                if (msg.type === 'join') {
                    // Se eu j√° estava na sala e algu√©m entrou, eu inicio a conex√£o (Initiator)
                    createPeerConnection(msg.sender, true);
                } 
                else if (msg.type === 'offer') {
                    // Recebi uma oferta. Crio a conex√£o (Receiver) e respondo.
                    const pc = createPeerConnection(msg.sender, false);
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: 'answer', room: roomId, sender: myId, target: msg.sender, sdp: answer }));
                } 
                else if (msg.type === 'answer' && msg.target === myId) {
                    // Recebi a resposta da minha oferta.
                    const pc = peers[msg.sender]?.connection;
                    if (pc) await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                } 
                else if (msg.type === 'ice-candidate' && msg.target === myId) {
                    // Trocando rotas de IP para perfurar NAT.
                    const pc = peers[msg.sender]?.connection;
                    if (pc) await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
                }
            } catch (e) { /* Ignora lixo no WebSocket p√∫blico */ }
        };
        
        ws.onclose = () => {
            // A sinaliza√ß√£o n√£o √© mais necess√°ria ap√≥s a malha WebRTC estabilizar.
            console.log("WebSocket desconectado. P2P WebRTC assumindo o controle total.");
        };
    }

    /* ======================================================================
       REDE MESH WEBRTC P2P
       ====================================================================== */
    function createPeerConnection(peerId, isInitiator) {
        if (peers[peerId]) return peers[peerId].connection;

        const pc = new RTCPeerConnection(webrtcConfig);
        peers[peerId] = { connection: pc, dataChannel: null, lastHeartbeat: Date.now() };

        // Anexa streams locais (Audio/Video)
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        // ICE Handling
        pc.onicecandidate = (event) => {
            if (event.candidate && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ice-candidate', room: roomId, sender: myId, target: peerId, candidate: event.candidate }));
            }
        };

        // Recebimento de M√≠dia
        pc.ontrack = (event) => {
            if (!document.getElementById(`video-${peerId}`)) {
                createVideoCard(peerId);
            }
            document.getElementById(`video-${peerId}`).srcObject = event.streams[0];
            adaptQuality(); 
        };

        // Data Channels (Onde ocorre a m√°gica do Chat, Arquivos e Anarquia)
        if (isInitiator) {
            const dc = pc.createDataChannel('gama-data');
            setupDataChannel(dc, peerId);
            
            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                if(ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'offer', room: roomId, sender: myId, target: peerId, sdp: offer }));
                }
            });
        } else {
            pc.ondatachannel = (event) => setupDataChannel(event.channel, peerId);
        }

        return pc;
    }

    function removePeer(peerId) {
        if (peers[peerId]) {
            peers[peerId].connection.close();
            delete peers[peerId];
        }
        const card = document.getElementById(`card-${peerId}`);
        if (card) {
            card.remove();
            addSystemMsg(`Um par foi desconectado.`);
        }
        adaptQuality();
    }

    /* ======================================================================
       CANAL DE DADOS (DATA CHANNEL)
       ====================================================================== */
    function setupDataChannel(dc, peerId) {
        peers[peerId].dataChannel = dc;
        dc.binaryType = 'arraybuffer'; // Crucial para transfer√™ncia de arquivos

        let incomingFileInfo = null;
        let incomingFileData = [];

        dc.onmessage = (event) => {
            peers[peerId].lastHeartbeat = Date.now();

            // Buffers Bin√°rios (Partes do Arquivo)
            if (event.data instanceof ArrayBuffer) {
                incomingFileData.push(event.data);
                return;
            }

            // Textos JSON
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'heartbeat') return; 
                
                if (data.type === 'chat') {
                    appendMessage(data.nickname, data.text);
                } 
                else if (data.type === 'image') {
                    appendImage(data.nickname, data.base64);
                }
                else if (data.type === 'control') {
                    handleAnarchyControl(data);
                }
                else if (data.type === 'file_start') {
                    incomingFileInfo = data;
                    incomingFileData = [];
                }
                else if (data.type === 'file_end') {
                    const blob = new Blob(incomingFileData);
                    appendFileLink(incomingFileInfo.sender, incomingFileInfo.name, blob);
                    incomingFileInfo = null;
                    incomingFileData = [];
                }
            } catch (e) { console.error("Erro parsing P2P data:", e); }
        };
    }

    function broadcastData(messageObj) {
        const msgStr = JSON.stringify(messageObj);
        Object.values(peers).forEach(p => {
            if (p.dataChannel && p.dataChannel.readyState === 'open') {
                p.dataChannel.send(msgStr);
            }
        });
    }

    // Toler√¢ncia a falhas (Self-Healing)
    function sendHeartbeat() { broadcastData({ type: 'heartbeat' }); }

    function checkNetworkHealth() {
        const now = Date.now();
        for (const peerId in peers) {
            if (now - peers[peerId].lastHeartbeat > 15000) {
                console.warn(`Timeout de P2P: Expurgando n√≥ ${peerId}`);
                removePeer(peerId);
            }
        }
    }

    /* ======================================================================
       CONTROLES DE UI E MODO ANARQUIA
       ====================================================================== */
    function createVideoCard(peerId) {
        const div = document.createElement('div');
        div.className = 'video-card';
        div.id = `card-${peerId}`;
        
        // Slider = Local Volume // Bot√µes = Controle An√°rquico Global
        div.innerHTML = `
            <video id="video-${peerId}" autoplay playsinline></video>
            <div class="peer-name">Peer An√¥nimo</div>
            <div class="peer-controls">
                <input type="range" min="0" max="1" step="0.1" value="1" onchange="document.getElementById('video-${peerId}').volume = this.value" title="Volume Local (Somente para voc√™)">
                <button onclick="sendAnarchyCommand('${peerId}', 'mute')" title="For√ßar Mute neste usu√°rio para TODOS">üîá</button>
                <button onclick="sendAnarchyCommand('${peerId}', 'hide')" title="For√ßar fechamento da c√¢mera deste usu√°rio">üö´</button>
            </div>
        `;
        document.getElementById('video-container').appendChild(div);
    }

    // "Anarquia": Emitindo uma ordem para outro navegador fechar seus dispositivos
    function sendAnarchyCommand(targetId, action) {
        broadcastData({ type: 'control', target: targetId, action: action, senderNick: myNickname });
        addSystemMsg(`Aviso: Voc√™ for√ßou uma a√ß√£o de modera√ß√£o global.`);
    }

    // O navegador alvo recebe a ordem e obedece
    function handleAnarchyControl(data) {
        if (data.target === myId) {
            if (data.action === 'mute') {
                const track = localStream.getAudioTracks()[0];
                if (track && track.enabled) toggleMic(); // Usa a fun√ß√£o existente para atualizar UI
                addSystemMsg(`üö® ${data.senderNick} silenciou o seu microfone.`);
            } 
            else if (data.action === 'hide') {
                const track = localStream.getVideoTracks()[0];
                if (track && track.enabled) toggleCam();
                addSystemMsg(`üö® ${data.senderNick} desligou a sua c√¢mera.`);
            }
        }
    }

    // Controles Locais
    function toggleMic() {
        const track = localStream?.getAudioTracks()[0];
        if(track) {
            track.enabled = !track.enabled;
            const btn = document.getElementById('btn-mic');
            btn.innerText = track.enabled ? "üéôÔ∏è Mic On" : "üéôÔ∏è Mic Off";
            btn.className = track.enabled ? "active" : "";
        }
    }

    function toggleCam() {
        const track = localStream?.getVideoTracks()[0];
        if(track) {
            track.enabled = !track.enabled;
            const btn = document.getElementById('btn-cam');
            btn.innerText = track.enabled ? "üìπ Cam On" : "üìπ Cam Off";
            btn.className = track.enabled ? "active" : "";
        }
    }

    async function shareScreen() {
        try {
            if(!screenStream) {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = screenStream.getVideoTracks()[0];
                
                Object.values(peers).forEach(p => {
                    const sender = p.connection.getSenders().find(s => s.track?.kind === 'video');
                    if(sender) sender.replaceTrack(screenTrack);
                });
                
                document.getElementById('local-video').srcObject = screenStream;
                const btn = document.getElementById('btn-screen');
                btn.innerText = "üñ•Ô∏è Parar Tela";
                btn.className = "active";

                screenTrack.onended = () => stopScreenShare();
            } else {
                stopScreenShare();
            }
        } catch(e) { console.error("Acesso √† tela cancelado."); }
    }

    function stopScreenShare() {
        if(screenStream) screenStream.getTracks().forEach(t => t.stop());
        screenStream = null;
        
        const videoTrack = localStream?.getVideoTracks()[0];
        Object.values(peers).forEach(p => {
            const sender = p.connection.getSenders().find(s => s.track?.kind === 'video');
            if(sender && videoTrack) sender.replaceTrack(videoTrack);
        });
        
        document.getElementById('local-video').srcObject = localStream;
        const btn = document.getElementById('btn-screen');
        btn.innerText = "üñ•Ô∏è Tela";
        btn.className = "";
    }

    /* ======================================================================
       CHAT, IMAGENS E TRANSFER√äNCIA DE ARQUIVOS
       ====================================================================== */
    function appendMessage(nick, text) {
        const history = document.getElementById('chat-history');
        history.innerHTML += `<div class="message"><strong>${nick}</strong> ${text}</div>`;
        history.scrollTop = history.scrollHeight;
    }

    function appendImage(nick, base64) {
        const history = document.getElementById('chat-history');
        history.innerHTML += `<div class="message"><strong>${nick}</strong><img src="${base64}"></div>`;
        history.scrollTop = history.scrollHeight;
    }

    function appendFileLink(nick, filename, blob) {
        const url = URL.createObjectURL(blob);
        const history = document.getElementById('chat-history');
        history.innerHTML += `<div class="message"><strong>${nick} enviou arquivo:</strong><a class="file-link" href="${url}" download="${filename}">üíæ ${filename} (Baixar)</a></div>`;
        history.scrollTop = history.scrollHeight;
    }

    function addSystemMsg(text) {
        const history = document.getElementById('chat-history');
        history.innerHTML += `<div class="system-msg">${text}</div>`;
        history.scrollTop = history.scrollHeight;
    }

    function sendText() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(text) {
            appendMessage("Voc√™", text);
            broadcastData({ type: 'chat', nickname: myNickname, text: text });
            input.value = '';
        }
    }

    // Suporte para "Enter"
    document.getElementById('chat-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendText();
    });

    // Captura de Imagem via Ctrl+V (Paste)
    document.getElementById('chat-input').addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result;
                    appendImage("Voc√™", base64);
                    broadcastData({ type: 'image', nickname: myNickname, base64: base64 });
                };
                reader.readAsDataURL(blob);
            }
        }
    });

    // Envio de Arquivos Fatiados (Chunking para evitar crash do DataChannel)
    async function sendFile(input) {
        const file = input.files[0];
        if(!file) return;

        addSystemMsg(`Enviando arquivo: ${file.name}...`);
        broadcastData({ type: 'file_start', sender: myNickname, name: file.name, size: file.size });

        const buffer = await file.arrayBuffer();
        let offset = 0;

        // Loop de envio de bytes
        while (offset < buffer.byteLength) {
            const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
            Object.values(peers).forEach(p => {
                if (p.dataChannel && p.dataChannel.readyState === 'open') {
                    p.dataChannel.send(chunk);
                }
            });
            offset += CHUNK_SIZE;
            // Atraso intencional m√≠nimo para liberar a thread e n√£o estourar o buffer interno do navegador
            await new Promise(r => setTimeout(r, 5)); 
        }

        broadcastData({ type: 'file_end', sender: myNickname });
        addSystemMsg(`Arquivo '${file.name}' transferido.`);
        
        // Coloca o arquivo localmente no chat do remetente tamb√©m
        const blob = new Blob([buffer]);
        appendFileLink("Voc√™", file.name, blob);
        
        input.value = ''; // Reseta o input
    }
</script>
</body>
</html>